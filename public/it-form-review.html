<!DOCTYPE html>
<html>

<head>
  <meta charset="UTF-8">
  <title>IT Final Review</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 20px;
      background: #f8f9fa;
    }

    .header {
      background: #007bff;
      color: white;
      padding: 20px;
      border-radius: 8px;
      margin-bottom: 20px;
    }

    .workflow-indicator {
      background: #e8f4f8;
      padding: 15px;
      border-left: 4px solid #007bff;
      margin-bottom: 20px;
      border-radius: 4px;
    }

    iframe {
      width: 100%;
      height: 700px;
      border: 2px solid #dee2e6;
      border-radius: 8px;
      margin: 25px 0;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    }

    .form-section {
      margin: 30px 0;
      padding: 0;
      background: none;
    }

    .form-section h3 {
      margin-top: 0;
      color: #495057;
      border-bottom: 2px solid #007bff;
      padding-bottom: 10px;
      font-size: 1.2rem;
    }

    .approval-section {
      background: #fff9e6;
      padding: 20px;
      margin: 20px 0;
      border-radius: 8px;
      border: 1px solid #ffc107;
    }

    .approval-section h3 {
      color: #856404;
      margin-top: 0;
    }

    .it-fields {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 15px;
      margin: 15px 0;
    }

    .it-fields input,
    .it-fields select {
      padding: 10px;
      border: 1px solid #ced4da;
      border-radius: 4px;
      font-size: 14px;
    }

    .it-fields label {
      font-weight: bold;
      color: #495057;
      margin-bottom: 5px;
      display: block;
    }

    .signature-upload {
      margin: 20px 0;
      padding: 15px;
      border: 2px dashed #ced4da;
      border-radius: 8px;
      text-align: center;
    }

    .signature-upload input[type="file"] {
      margin: 10px 0;
    }

    .signature-preview {
      margin-top: 10px;
      max-height: 100px;
      border: 1px solid #dee2e6;
      border-radius: 4px;
      display: none;
    }

    .action-buttons {
      display: flex;
      gap: 15px;
      justify-content: center;
      margin: 30px 0;
      padding: 0;
    }

    .btn {
      padding: 12px 24px;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-size: 16px;
      font-weight: bold;
      transition: all 0.3s ease;
    }

    .btn:disabled {
      opacity: 0.6;
      cursor: not-allowed;
    }

    .btn-complete {
      background: #28a745;
      color: white;
    }

    .btn-complete:hover:not(:disabled) {
      background: #218838;
    }

    .btn-reject {
      background: #dc3545;
      color: white;
    }

    .btn-reject:hover:not(:disabled) {
      background: #c82333;
    }

    .btn-cancel {
      background: #6c757d;
      color: white;
    }

    .btn-cancel:hover:not(:disabled) {
      background: #5a6268;
    }

    .status-message {
      margin: 10px 0;
      padding: 15px;
      border-radius: 6px;
      font-weight: bold;
      text-align: center;
    }

    .status-loading {
      background: #d4edda;
      color: #155724;
    }

    .status-error {
      background: #f8d7da;
      color: #721c24;
    }

    .status-success {
      background: #d1ecf1;
      color: #0c5460;
    }

    .remarks-section {
      margin: 20px 0;
    }

    .remarks-section textarea {
      width: 100%;
      min-height: 100px;
      padding: 12px;
      border: 1px solid #ced4da;
      border-radius: 6px;
      font-family: inherit;
      resize: vertical;
    }

    .employee-info {
      padding: 15px 0;
      margin: 15px 0;
    }

    .employee-info h4 {
      color: #007bff;
    }

    .hod-signature-frame {
      border: 3px solid #28a745 !important;
      background: #f8fff9 !important;
    }

    /* HOD Info Display */
    .hod-info {
      background: #d4edda;
      border: 1px solid #28a745;
      border-radius: 8px;
      padding: 15px;
      margin: 15px 0;
    }

    .hod-info h4 {
      color: #155724;
      margin-bottom: 10px;
    }
  </style>
</head>

<body>
  <div class="header">
    <h1>IT Final Review & Processing</h1>
    <p>Form ID: <span id="formIdLbl"></span> | Status: Final IT Review</p>
  </div>
  <div class="workflow-indicator">
    <strong>Final Stage:</strong> Review forms with all employee and HOD details filled in their original positions,
    then add IT approval.
  </div>
  <div id="statusMessage" class="status-message" style="display: none;"></div>

  <!-- Employee Info Section -->
  <div class="form-section">
    <h3>Employee Information</h3>
    <div id="employeeInfo" class="employee-info">Loading employee details...</div>
  </div>
  <!-- HOD Approval Info Section -->
  <div class="form-section">
    <h3>HOD Approval Details</h3>
    <div id="hodInfo" class="hod-info">Loading HOD approval details...</div>
  </div>
  <!-- Forms with Embedded Employee + HOD Details -->
  <div class="form-section">
    <h3>Disposal Form (Employee & HOD Completed)</h3>
    <iframe id="disposalFrame" src="" data-form-key="disposalForm"></iframe>
  </div>
  <div class="form-section">
    <h3>E-file Form (Employee & HOD Completed)</h3>
    <iframe id="efileFrame" src="" data-form-key="efileForm"></iframe>
  </div>
  <div class="form-section">
    <h3>Form 365 (Employee & HOD Completed)</h3>
    <iframe id="form365Frame" src="" data-form-key="form365"></iframe>
  </div>
  <!-- IT Approval Section -->
  <div class="approval-section">
    <h3>IT Final Approval</h3>
    <div class="it-fields">
      <div>
        <label for="itOfficerName">IT Officer Name *</label>
        <input type="text" id="itOfficerName" required placeholder="Enter your name">
      </div>
      <div>
        <label for="itOfficerId">IT Officer ID *</label>
        <input type="text" id="itOfficerId" required placeholder="Enter your employee ID">
      </div>
      <div>
        <label for="itEmail">IT Email *</label>
        <input type="email" id="itEmail" required placeholder="Enter your email">
      </div>
      <div>
        <label for="itDecision">Decision *</label>
        <select id="itDecision" required>
          <option value="">Select Decision</option>
          <option value="approved">Approve & Complete</option>
          <option value="rejected">Reject & Return</option>
        </select>
      </div>
    </div>
    <div class="signature-upload">
      <label for="itSignatureFile"><strong>IT Officer Signature *</strong></label>
      <br>
      <input type="file" id="itSignatureFile" accept="image/*" required>
      <div class="text-muted">Upload your digital signature (PNG, JPG, GIF)</div>
      <img id="itSignaturePreview" class="signature-preview" alt="IT Signature Preview">
    </div>
    <div class="remarks-section">
      <label for="itRemarks"><strong>IT Remarks</strong></label>
      <textarea id="itRemarks" placeholder="Add any additional remarks or instructions..."></textarea>
    </div>
  </div>
  <!-- Action Buttons -->
  <div class="action-buttons">
    <button id="completeBtn" class="btn btn-complete" disabled>
      Complete Clearance
    </button>
    <button id="rejectBtn" class="btn btn-reject" disabled>
      Reject & Return
    </button>
    <button id="cancelBtn" class="btn btn-cancel" onclick="window.close()">
      Cancel
    </button>
  </div>
  <script>
    const qs = new URLSearchParams(location.search);
    const formId = qs.get('formId');
    const $ = s => document.getElementById(s);
    // Initialize
    $('formIdLbl').textContent = formId || 'Unknown';
    let formData = null;
    let itSignatureData = null;
    let hodSignatureUrl = null;
    let hodApprovalData = null;
    // Show status messages
    function showStatus(message, type = 'loading') {
      const statusEl = $('statusMessage');
      statusEl.textContent = message;
      statusEl.className = `status-message status-${type}`;
      statusEl.style.display = 'block';
    }
    function hideStatus() {
      $('statusMessage').style.display = 'none';
    }
    // Enhanced HOD signature injection with better logging
    function injectHODSignature(iframe, signatureUrl) {
      if (!signatureUrl) {
        return false;
      }
      try {
        const doc = iframe.contentDocument || iframe.contentWindow.document;
        if (!doc) {
          return false;
        }
        // Multiple signature selectors with more thorough search
        const signatureSelectors = [
          '#hodSignatureArea',
          '#hodSignature',
          '#signatureArea',
          '[id*="hod"][id*="signature"]',
          '[id*="signature"][id*="area"]',
          '[id*="signature"][id*="hod"]',
          '.signature-area',
          '.hod-signature',
          'img[alt*="signature" i]',
          'img[id*="signature"]',
          'div[class*="signature"]',
          '*[id*="hodSignatureArea"]'
        ];
        let signatureInjected = false;
        let elementsFound = 0;
        signatureSelectors.forEach(selector => {
          const elements = doc.querySelectorAll(selector);
          if (elements.length > 0) {
            elementsFound += elements.length;
          }
          elements.forEach((element, index) => {
            if (element.tagName === 'IMG') {
              // Direct image element
              element.src = signatureUrl;
              element.style.display = 'block';
              element.style.maxHeight = '80px';
              element.style.maxWidth = '200px';
              element.style.border = '3px solid #28a745';
              element.style.borderRadius = '8px';
              element.style.padding = '8px';
              element.style.background = '#f8fff9';
              element.alt = 'HOD Digital Signature';
              signatureInjected = true;
            } else {
              // Container element
              element.innerHTML = `
                <div style="text-align: center; padding: 10px; border: 2px solid #28a745; border-radius: 8px; background: #f8fff9;">
                  <img src="${signatureUrl}" 
                       alt="HOD Digital Signature" 
                       style="max-height: 80px; max-width: 200px; display: block; margin: 0 auto; 
                              border: 2px solid #28a745; border-radius: 6px; padding: 5px; 
                              background: white;">
                  <div style="background: #d4edda; color: #155724; padding: 8px 12px; border-radius: 4px; 
                              margin-top: 10px; font-weight: bold; font-size: 14px;">
                    HOD Digital Signature Applied
                  </div>
                </div>
              `;
              element.classList.add('has-signature');
              signatureInjected = true;
            }
          });
        });
        // If no specific containers found, try to find ANY element with text containing "signature"
        if (!signatureInjected) {
          const allElements = doc.querySelectorAll('div, span, p');
          allElements.forEach(element => {
            const text = element.textContent.toLowerCase();
            if ((text.includes('signature') && text.includes('hod')) ||
              (text.includes('upload') && text.includes('signature')) ||
              text.includes('click to upload hod signature')) {
              element.innerHTML = `
                <div style="text-align: center; padding: 15px; border: 3px solid #28a745; border-radius: 8px; background: #f8fff9;">
                  <img src="${signatureUrl}" 
                       alt="HOD Digital Signature" 
                       style="max-height: 80px; max-width: 200px; display: block; margin: 0 auto; 
                              border: 2px solid #28a745; border-radius: 6px; padding: 8px; 
                              background: white;">
                  <div style="background: #d4edda; color: #155724; padding: 8px 12px; border-radius: 4px; 
                              margin-top: 10px; font-weight: bold;">
                    HOD Digital Signature Applied
                  </div>
                </div>
              `;
              signatureInjected = true;
            }
          });
        }
        if (signatureInjected) {
          iframe.classList.add('hod-signature-frame');
        } else {
          // Last resort: create a new signature area at the end of the document
          const body = doc.body;
          if (body) {
            const signatureDiv = doc.createElement('div');
            signatureDiv.innerHTML = `
              <div style="text-align: center; padding: 20px; border: 3px solid #28a745; border-radius: 8px; 
                          background: #f8fff9; margin: 20px 0;">
                <h3 style="color: #155724; margin-bottom: 15px;">HOD Digital Signature</h3>
                <img src="${signatureUrl}" 
                     alt="HOD Digital Signature" 
                     style="max-height: 80px; max-width: 200px; display: block; margin: 0 auto; 
                            border: 2px solid #28a745; border-radius: 6px; padding: 8px; 
                            background: white;">
                <div style="background: #d4edda; color: #155724; padding: 8px 12px; border-radius: 4px; 
                            margin-top: 10px; font-weight: bold;">
                  HOD Digital Signature Applied
                </div>
              </div>
            `;
            body.appendChild(signatureDiv);
            signatureInjected = true;
          }
        }
        return signatureInjected;
      } catch (error) {
        return false;
      }
    }
    // Enhanced table styling with more aggressive CSS
    function enhanceTableVisibility(iframe) {
      try {
        const doc = iframe.contentDocument || iframe.contentWindow.document;
        if (!doc) return;
        const style = doc.createElement('style');
        style.id = 'itReviewTableStyles';
        style.textContent = `
          /* AGGRESSIVE table styling - highest specificity */
          table, table.table, .table-container table {
            width: 100% !important;
            border-collapse: collapse !important;
            margin: 20px 0 !important;
            border: 3px solid #007bff !important;
            background: white !important;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1) !important;
          }
          
          th, td, table th, table td {
            border: 2px solid #007bff !important;
            padding: 15px 10px !important;
            text-align: left !important;
            vertical-align: top !important;
            background: white !important;
          }
          
          th, table th {
            background: linear-gradient(135deg, #007bff 0%, #0056b3 100%) !important;
            color: white !important;
            font-weight: bold !important;
            text-align: center !important;
            font-size: 16px !important;
          }
          
          td, table td {
            background: #f8f9fa !important;
            font-size: 14px !important;
          }
          
          tr:nth-child(even) td {
            background: #e9ecef !important;
          }
          
          tr:hover td {
            background: #fff3cd !important;
          }
          
          /* Enhanced input visibility */
          table input, table select, table textarea {
            width: 95% !important;
            padding: 10px !important;
            border: 2px solid #ced4da !important;
            border-radius: 6px !important;
            background: white !important;
            font-size: 14px !important;
            box-shadow: inset 0 1px 3px rgba(0,0,0,0.1) !important;
          }
          
          table input:disabled, table select:disabled, table textarea:disabled {
            background: #e9ecef !important;
            border-color: #6c757d !important;
            color: #495057 !important;
            font-weight: bold !important;
          }
          
          table input:focus, table select:focus, table textarea:focus {
            border-color: #007bff !important;
            box-shadow: 0 0 0 3px rgba(0,123,255,0.25) !important;
          }
          
          /* Special styling for HOD fields */
          table input[id*="hod" i], table select[id*="hod" i], table textarea[id*="hod" i] {
            background: linear-gradient(135deg, #d4edda 0%, #c3e6cb 100%) !important;
            border-color: #28a745 !important;
            color: #155724 !important;
            font-weight: bold !important;
          }
          
          /* Make sure tables are visible */
          .table-responsive, .table-container {
            overflow-x: auto !important;
            margin: 20px 0 !important;
          }
        `;
        const target = doc.head || doc.body;
        if (target && !doc.querySelector('#itReviewTableStyles')) {
          target.appendChild(style);
          // Force table visibility
          setTimeout(() => {
            const tables = doc.querySelectorAll('table');
            tables.forEach((table, index) => {
              table.style.display = 'table';
              table.style.visibility = 'visible';
            });
          }, 500);
        }
      } catch (error) {
      }
    }
    // Enhanced API blocking
    function disableIframeAPICall(iframe) {
      try {
        const iframeWindow = iframe.contentWindow;
        const iframeDoc = iframe.contentDocument || iframeWindow.document;
        // Direct function override
        if (iframeWindow && typeof iframeWindow.loadFormData === 'function') {
          iframeWindow.loadFormData = function () {
            return Promise.resolve();
          };
        }
        // Script injection
        if (iframeDoc && !iframeDoc.querySelector('#itReviewBlocker')) {
          const script = iframeDoc.createElement('script');
          script.id = 'itReviewBlocker';
          const timestamp = Date.now();
          script.textContent = `
            (function() {
              
              if (typeof window.loadFormData === 'function') {
                window.loadFormData = function() {
                  return Promise.resolve();
                };
              }
              
              if (!window.__itFetchBlocked_${timestamp}) {
                const origFetch = window.fetch;
                window.fetch = function(url, options) {
                  if (typeof url === 'string' && (
                      url.includes('/api/employee/form-data') || 
                      url.includes('/api/hod/form-details')
                  )) {
                    return Promise.reject(new Error('API blocked by IT review'));
                  }
                  return origFetch.apply(this, arguments);
                };
                window.__itFetchBlocked_${timestamp} = true;
              }
              
              window.userRole = 'it';
            })();
          `;
          const target = iframeDoc.head || iframeDoc.body || iframeDoc.documentElement;
          if (target) {
            target.appendChild(script);
          }
        }
        return true;
      } catch (error) {
        return false;
      }
    }
    // Enhanced form data loading with proper HOD signature extraction
    async function loadFormData() {
      try {
        showStatus('Loading forms with complete employee and HOD details...', 'loading');
        const response = await fetch(`/api/itadmin/form-details/${formId}`, {
          credentials: 'include'
        });
        if (!response.ok) {
          throw new Error(`Server responded with ${response.status}`);
        }
        const data = await response.json();
        if (!data.success) {
          throw new Error(data.message || 'Failed to load form data');
        }
        formData = data;
        // Extract HOD signature from the CORRECT location
        if (data.hodApproval) {
          hodApprovalData = data.hodApproval;
          // Check for signature in hodApproval object
          const possibleSignatureFields = [
            'signature',
            'hodSignature',
            'signatureDataUrl',
            'signatureUrl',
            'digitalSignature'
          ];
          possibleSignatureFields.forEach(field => {
            if (hodApprovalData[field] && !hodSignatureUrl) {
              hodSignatureUrl = hodApprovalData[field];
            }
          });
        }
        // Also check in forms as fallback
        if (!hodSignatureUrl && data.forms) {
          Object.values(data.forms).forEach(form => {
            if (form) {
              const possibleSignatureFields = [
                'hodSignature',
                'signatureDataUrl',
                'signature'
              ];
              possibleSignatureFields.forEach(field => {
                if (form[field] && !hodSignatureUrl) {
                  hodSignatureUrl = form[field];
                }
              });
            }
          });
        }
        // Display information and setup forms
        displayEmployeeInfo(data.employee);
        displayHODInfo(data.hodApproval);
        setupCompleteFormsView(data.forms, data.noDuesType);
        hideStatus();
      } catch (error) {
        showStatus(`Failed to load form data: ${error.message}`, 'error');
      }
    }
    // Display employee information
    function displayEmployeeInfo(employee) {
      $('employeeInfo').innerHTML = `
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; 
                    background: #f8f9fa; padding: 15px; border-radius: 8px; border: 1px solid #dee2e6;">
          <div><strong>Name:</strong> ${employee.name}</div>
          <div><strong>Employee ID:</strong> ${employee.employeeId}</div>
          <div><strong>Department:</strong> ${employee.department}</div>
        </div>
      `;
    }
    // Display HOD approval information
    function displayHODInfo(hodApproval) {
      if (!hodApproval) {
        $('hodInfo').innerHTML = '<p>No HOD approval data available</p>';
        return;
      }
      $('hodInfo').innerHTML = `
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
          <div><strong>Approved By:</strong> ${hodApproval.approvedBy || 'N/A'}</div>
          <div><strong>HOD Employee ID:</strong> ${hodApproval.approverEmployeeId || 'N/A'}</div>
          <div><strong>HOD Email:</strong> ${hodApproval.approverEmail || 'N/A'}</div>
          <div><strong>Department:</strong> ${hodApproval.approverDepartment || 'N/A'}</div>
          <div><strong>Approval Date:</strong> ${hodApproval.approvalDate ? new Date(hodApproval.approvalDate).toLocaleString() : 'N/A'}</div>
          <div><strong>Signature:</strong> ${hodSignatureUrl ? 'Available (' + hodSignatureUrl.length + ' chars)' : 'Not found'}</div>
        </div>
        ${hodApproval.remarks ? `<div style="margin-top: 10px;"><strong>HOD Remarks:</strong> ${hodApproval.remarks}</div>` : ''}
      `;
    }
    // Enhanced form setup with better timing
    function setupCompleteFormsView(forms, noDuesType) {
      const framesToLoad = [
        {
          frameId: 'disposalFrame',
          url: 'forms/disposalform.html',
          key: 'disposalForm'
        },
        {
          frameId: 'efileFrame',
          url: 'forms/efile.html',
          key: 'efileForm'
        },
        {
          frameId: 'form365Frame',
          url: noDuesType === 'Transfer' ? 'forms/form365transfer.html' : 'forms/form365disposal.html',
          key: noDuesType === 'Transfer' ? 'form365Trans' : 'form365Disp'
        }
      ];
      framesToLoad.forEach((frameInfo, index) => {
        const frame = $(frameInfo.frameId);
        frame.src = `${frameInfo.url}?role=it&formId=${encodeURIComponent(formId)}&skipLoad=true&itReview=true&hasSignature=${hodSignatureUrl ? 'true' : 'false'}&timestamp=${Date.now()}`;
        frame.dataset.formKey = frameInfo.key;
        frame.onload = () => {
          const delay = 1200 + (index * 500); // Longer delays
          setTimeout(() => {
            disableIframeAPICall(frame);
            enhanceTableVisibility(frame);
            setTimeout(() => {
              populateFormWithAllData(frame, forms[frameInfo.key]);
              // Inject HOD signature with even longer delay
              setTimeout(() => {
                if (hodSignatureUrl) {
                  const success = injectHODSignature(frame, hodSignatureUrl);
                } else {
                }
              }, 1000);
            }, 800);
          }, delay);
        };
      });
    }
    // Enhanced form population with HOD data integration
    function populateFormWithAllData(iframe, formData) {
      if (!formData) {
        return;
      }
      try {
        const doc = iframe.contentDocument || iframe.contentWindow.document;
        if (!doc) {
          return;
        }
        // Combine form data with HOD approval data
        const allData = { ...formData };
        if (hodApprovalData) {
          // Add HOD data with appropriate field names
          allData.hodName = hodApprovalData.approvedBy;
          allData.hodEmployeeId = hodApprovalData.approverEmployeeId;
          allData.hodEmail = hodApprovalData.approverEmail;
          allData.hodDepartment = hodApprovalData.approverDepartment;
          allData.hodDesignation = hodApprovalData.approverDesignation;
          allData.hodApprovalDate = hodApprovalData.approvalDate;
          allData.hodRemarks = hodApprovalData.remarks;
          allData.hodSignature = hodSignatureUrl;
          allData.hodSignatureArea = hodSignatureUrl;
        }
        // Populate ALL form fields
        Object.entries(allData).forEach(([fieldId, value]) => {
          if (!value) return;
          const element = doc.getElementById(fieldId);
          if (!element) return;
          const tagName = element.tagName.toLowerCase();
          if (tagName === 'input' || tagName === 'select' || tagName === 'textarea') {
            element.value = value;
            element.disabled = true;
            if (fieldId.toLowerCase().includes('hod')) {
              element.style.backgroundColor = '#d4edda';
              element.style.border = '2px solid #28a745';
              element.style.fontWeight = 'bold';
              element.style.color = '#155724';
            }
          } else if (tagName === 'img') {
            if (value && value.trim()) {
              element.src = value;
              element.style.display = 'block';
              if (fieldId.toLowerCase().includes('hod') && fieldId.toLowerCase().includes('signature')) {
                element.style.border = '3px solid #28a745';
                element.style.borderRadius = '8px';
                element.style.padding = '8px';
                element.style.backgroundColor = '#f8fff9';
                element.style.maxHeight = '80px';
                element.style.maxWidth = '200px';
              }
            }
          } else {
            element.textContent = value;
            if (fieldId.toLowerCase().includes('hod')) {
              element.style.backgroundColor = '#d4edda';
              element.style.padding = '4px 8px';
              element.style.borderRadius = '4px';
              element.style.fontWeight = 'bold';
              element.style.border = '1px solid #28a745';
              element.style.color = '#155724';
            }
          }
        });
      } catch (error) {
      }
    }
    // Handle IT signature upload
    $('itSignatureFile').onchange = function (event) {
      const file = event.target.files[0];
      if (!file) return;
      const reader = new FileReader();
      reader.onload = function (e) {
        itSignatureData = e.target.result;
        const preview = $('itSignaturePreview');
        preview.src = itSignatureData;
        preview.style.display = 'block';
        updateButtonStates();
      };
      reader.readAsDataURL(file);
    };
    // Update button states based on form completion
    function updateButtonStates() {
      const name = $('itOfficerName').value.trim();
      const id = $('itOfficerId').value.trim();
      const email = $('itEmail').value.trim();
      const decision = $('itDecision').value;
      const hasSignature = !!itSignatureData;
      const isFormComplete = name && id && email && decision && hasSignature;
      $('completeBtn').disabled = !isFormComplete || decision !== 'approved';
      $('rejectBtn').disabled = !isFormComplete || decision !== 'rejected';
    }
    // Attach event listeners for form validation
    ['itOfficerName', 'itOfficerId', 'itEmail', 'itDecision'].forEach(fieldId => {
      $(fieldId).addEventListener('input', updateButtonStates);
      $(fieldId).addEventListener('change', updateButtonStates);
    });
    // Complete clearance
    $('completeBtn').onclick = async function () {
      if (this.disabled) return;
      if (!confirm('Are you sure you want to complete this clearance? This action cannot be undone.')) {
        return;
      }
      await processITDecision('complete');
    };
    // Reject clearance
    $('rejectBtn').onclick = async function () {
      if (this.disabled) return;
      const remarks = $('itRemarks').value.trim();
      if (!remarks) {
        alert('Please provide remarks for rejection.');
        $('itRemarks').focus();
        return;
      }
      if (!confirm('Are you sure you want to reject this clearance? It will be returned to the employee.')) {
        return;
      }
      await processITDecision('reject');
    };
    // Process IT decision
    async function processITDecision(action) {
      try {
        showStatus(`${action === 'complete' ? 'Completing' : 'Rejecting'} clearance...`, 'loading');
        const allFormData = {};
        const iframes = document.querySelectorAll('iframe[data-form-key]');
        for (const iframe of iframes) {
          const key = iframe.dataset.formKey;
          const doc = iframe.contentDocument || iframe.contentWindow.document;
          const data = {};
          if (doc) {
            doc.querySelectorAll('[id]').forEach(el => {
              if (['INPUT', 'SELECT', 'TEXTAREA'].includes(el.tagName)) {
                data[el.id] = el.value;
              } else if (el.tagName === 'IMG') {
                data[el.id] = el.src;
              } else {
                data[el.id] = el.textContent.trim();
              }
            });
          }
          // Add IT approval data
          data.itOfficerName = $('itOfficerName').value;
          data.itOfficerId = $('itOfficerId').value;
          data.itEmail = $('itEmail').value;
          data.itDecision = $('itDecision').value;
          data.itSignature = itSignatureData;
          data.itRemarks = $('itRemarks').value;
          data.itProcessedDate = new Date().toISOString();
          allFormData[key] = data;
        }
        const payload = {
          formId,
          formResponses: allFormData,
          action,
          remarks: $('itRemarks').value
        };
        const response = await fetch('/api/itadmin/final-process', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          credentials: 'include',
          body: JSON.stringify(payload)
        });
        const result = await response.json();
        if (response.ok && result.success) {
          showStatus(
            action === 'complete'
              ? 'Clearance completed successfully!'
              : 'Clearance rejected and returned',
            'success'
          );
          $('completeBtn').disabled = true;
          $('rejectBtn').disabled = true;
          setTimeout(() => {
            window.close();
          }, 3000);
        } else {
          throw new Error(result.message || 'Processing failed');
        }
      } catch (error) {
        showStatus(`Error: ${error.message}`, 'error');
      }
    }
    // Initialize on page load
    window.addEventListener('DOMContentLoaded', loadFormData);
  </script>
</body>

</html>