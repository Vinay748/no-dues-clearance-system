now this
<!DOCTYPE html>
<html>


<head>
  Â 
  <meta charset="UTF-8">
  Â  <title>IT Final Review</title>
  Â  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 20px;
      background: #f8f9fa;
    }


    .header {
      background: #007bff;
      color: white;
      padding: 20px;
      border-radius: 8px;
      margin-bottom: 20px;
    }


    .workflow-indicator {
      background: #e8f4f8;
      padding: 15px;
      border-left: 4px solid #007bff;
      margin-bottom: 20px;
      border-radius: 4px;
    }


    iframe {
      width: 100%;
      height: 700px;
      border: 2px solid #dee2e6;
      border-radius: 8px;
      margin: 25px 0;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    }


    .form-section {
      margin: 30px 0;
      padding: 0;
      background: none;
    }


    .form-section h3 {
      margin-top: 0;
      color: #495057;
      border-bottom: 2px solid #007bff;
      padding-bottom: 10px;
      font-size: 1.2rem;
    }


    .approval-section {
      background: #fff9e6;
      padding: 20px;
      margin: 20px 0;
      border-radius: 8px;
      border: 1px solid #ffc107;
    }


    .approval-section h3 {
      color: #856404;
      margin-top: 0;
    }


    .it-fields {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 15px;
      margin: 15px 0;
    }


    .it-fields input,
    .it-fields select {
      padding: 10px;
      border: 1px solid #ced4da;
      border-radius: 4px;
      font-size: 14px;
    }


    .it-fields label {
      font-weight: bold;
      color: #495057;
      margin-bottom: 5px;
      display: block;
    }


    .signature-upload {
      margin: 20px 0;
      padding: 15px;
      border: 2px dashed #ced4da;
      border-radius: 8px;
      text-align: center;
    }


    .signature-upload input[type="file"] {
      margin: 10px 0;
    }


    .signature-preview {
      margin-top: 10px;
      max-height: 100px;
      border: 1px solid #dee2e6;
      border-radius: 4px;
      display: none;
    }


    .action-buttons {
      display: flex;
      gap: 15px;
      justify-content: center;
      margin: 30px 0;
      padding: 0;
    }


    .btn {
      padding: 12px 24px;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-size: 16px;
      font-weight: bold;
      transition: all 0.3s ease;
    }


    .btn:disabled {
      opacity: 0.6;
      cursor: not-allowed;
    }


    .btn-complete {
      background: #28a745;
      color: white;
    }


    .btn-complete:hover:not(:disabled) {
      background: #218838;
    }


    .btn-reject {
      background: #dc3545;
      color: white;
    }


    .btn-reject:hover:not(:disabled) {
      background: #c82333;
    }


    .btn-cancel {
      background: #6c757d;
      color: white;
    }


    .btn-cancel:hover:not(:disabled) {
      background: #5a6268;
    }


    .status-message {
      margin: 10px 0;
      padding: 15px;
      border-radius: 6px;
      font-weight: bold;
      text-align: center;
    }


    .status-loading {
      background: #d4edda;
      color: #155724;
    }


    .status-error {
      background: #f8d7da;
      color: #721c24;
    }


    .status-success {
      background: #d1ecf1;
      color: #0c5460;
    }


    .remarks-section {
      margin: 20px 0;
    }


    .remarks-section textarea {
      width: 100%;
      min-height: 100px;
      padding: 12px;
      border: 1px solid #ced4da;
      border-radius: 6px;
      font-family: inherit;
      resize: vertical;
    }


    .employee-info {
      padding: 15px 0;
      margin: 15px 0;
    }


    .employee-info h4 {
      color: #007bff;
    }


    .hod-signature-frame {
      border: 3px solid #28a745 !important;
      background: #f8fff9 !important;
    }


    /* HOD Info Display */
    .hod-info {
      background: #d4edda;
      border: 1px solid #28a745;
      border-radius: 8px;
      padding: 15px;
      margin: 15px 0;
    }


    .hod-info h4 {
      color: #155724;
      margin-bottom: 10px;
    }


    .debug-info {
      background: #f8d7da;
      border: 1px solid #dc3545;
      border-radius: 8px;
      padding: 15px;
      margin: 15px 0;
      font-family: monospace;
      font-size: 12px;
    }
  </style>
</head>


<body>
  Â  <div class="header">
    Â  Â  <h1>ğŸ”§ IT Final Review & Processing</h1>
    Â  Â  <p>Form ID: <span id="formIdLbl"></span> | Status: Final IT Review</p>
    Â  </div>


  Â  <div class="workflow-indicator">
    Â  Â  <strong>ğŸ“‹ Final Stage:</strong> Review forms with all employee and HOD details filled in their original
    positions,
    Â  Â  then add IT approval.
    Â  </div>


  Â  <div id="statusMessage" class="status-message" style="display: none;"></div>


  Â  <!-- Debug Info Section -->
  Â  <div class="debug-info" id="debugInfo" style="display: none;">
    Â  Â  <strong>Debug Information:</strong>
    Â  Â  <div id="debugContent"></div>
    Â  </div>


  Â  <!-- Employee Info Section -->
  Â  <div class="form-section">
    Â  Â  <h3>ğŸ‘¤ Employee Information</h3>
    Â  Â  <div id="employeeInfo" class="employee-info">Loading employee details...</div>
    Â  </div>


  Â  <!-- HOD Approval Info Section -->
  Â  <div class="form-section">
    Â  Â  <h3>âœ… HOD Approval Details</h3>
    Â  Â  <div id="hodInfo" class="hod-info">Loading HOD approval details...</div>
    Â  </div>


  Â  <!-- Forms with Embedded Employee + HOD Details -->
  Â  <div class="form-section">
    Â  Â  <h3>ğŸ“„ Disposal Form (Employee & HOD Completed)</h3>
    Â  Â  <iframe id="disposalFrame" src="" data-form-key="disposalForm"></iframe>
    Â  </div>


  Â  <div class="form-section">
    Â  Â  <h3>ğŸ“§ E-file Form (Employee & HOD Completed)</h3>
    Â  Â  <iframe id="efileFrame" src="" data-form-key="efileForm"></iframe>
    Â  </div>


  Â  <div class="form-section">
    Â  Â  <h3>ğŸ”„ Form 365 (Employee & HOD Completed)</h3>
    Â  Â  <iframe id="form365Frame" src="" data-form-key="form365"></iframe>
    Â  </div>


  Â  <!-- IT Approval Section -->
  Â  <div class="approval-section">
    Â  Â  <h3>ğŸ”§ IT Final Approval</h3>
    Â  Â  <div class="it-fields">
      Â  Â  Â  <div>
        Â  Â  Â  Â  <label for="itOfficerName">IT Officer Name *</label>
        Â  Â  Â  Â  <input type="text" id="itOfficerName" required placeholder="Enter your name">
        Â  Â  Â  </div>
      Â  Â  Â  <div>
        Â  Â  Â  Â  <label for="itOfficerId">IT Officer ID *</label>
        Â  Â  Â  Â  <input type="text" id="itOfficerId" required placeholder="Enter your employee ID">
        Â  Â  Â  </div>
      Â  Â  Â  <div>
        Â  Â  Â  Â  <label for="itEmail">IT Email *</label>
        Â  Â  Â  Â  <input type="email" id="itEmail" required placeholder="Enter your email">
        Â  Â  Â  </div>
      Â  Â  Â  <div>
        Â  Â  Â  Â  <label for="itDecision">Decision *</label>
        Â  Â  Â  Â  <select id="itDecision" required>
          Â  Â  Â  Â  Â  <option value="">Select Decision</option>
          Â  Â  Â  Â  Â  <option value="approved">âœ… Approve & Complete</option>
          Â  Â  Â  Â  Â  <option value="rejected">âŒ Reject & Return</option>
          Â  Â  Â  Â  </select>
        Â  Â  Â  </div>
      Â  Â  </div>


    Â  Â  <div class="signature-upload">
      Â  Â  Â  <label for="itSignatureFile"><strong>IT Officer Signature *</strong></label>
      Â  Â  Â  <br>
      Â  Â  Â  <input type="file" id="itSignatureFile" accept="image/*" required>
      Â  Â  Â  <div class="text-muted">Upload your digital signature (PNG, JPG, GIF)</div>
      Â  Â  Â  <img id="itSignaturePreview" class="signature-preview" alt="IT Signature Preview">
      Â  Â  </div>


    Â  Â  <div class="remarks-section">
      Â  Â  Â  <label for="itRemarks"><strong>IT Remarks</strong></label>
      Â  Â  Â  <textarea id="itRemarks" placeholder="Add any additional remarks or instructions..."></textarea>
      Â  Â  </div>
    Â  </div>


  Â  <!-- Action Buttons -->
  Â  <div class="action-buttons">
    Â  Â  <button id="completeBtn" class="btn btn-complete" disabled>
      Â  Â  Â  âœ… Complete Clearance
      Â  Â  </button>
    Â  Â  <button id="rejectBtn" class="btn btn-reject" disabled>
      Â  Â  Â  âŒ Reject & Return
      Â  Â  </button>
    Â  Â  <button id="cancelBtn" class="btn btn-cancel" onclick="window.close()">
      Â  Â  Â  ğŸš« Cancel
      Â  Â  </button>
    Â  </div>


  Â 
  <script>
    const qs = new URLSearchParams(location.search);
    const formId = qs.get('formId');
    const $ = s => document.getElementById(s);


    // Initialize
    $('formIdLbl').textContent = formId || 'Unknown';


    let formData = null;
    let itSignatureData = null;
    let hodSignatureUrl = null;
    let hodApprovalData = null;


    // Show status messages
    function showStatus(message, type = 'loading') {
      const statusEl = $('statusMessage');
      statusEl.textContent = message;
      statusEl.className = `status-message status-${type}`;
      statusEl.style.display = 'block';
    }


    function hideStatus() {
      $('statusMessage').style.display = 'none';
    }


    // Debug function
    function showDebugInfo(info) {
      $('debugInfo').style.display = 'block';
      $('debugContent').innerHTML = `<pre>${JSON.stringify(info, null, 2)}</pre>`;
    }


    // âœ… FIXED: Enhanced HOD signature injection with better logging
    function injectHODSignature(iframe, signatureUrl) {
      if (!signatureUrl) {
        console.log('âŒ No HOD signature URL available');
        return false;
      }


      console.log('ğŸ” Attempting to inject HOD signature:', signatureUrl.substring(0, 50) + '...');


      try {
        const doc = iframe.contentDocument || iframe.contentWindow.document;
        if (!doc) {
          console.log('âŒ Cannot access iframe document');
          return false;
        }


        // Multiple signature selectors with more thorough search
        const signatureSelectors = [
          '#hodSignatureArea',
          '#hodSignature',
          '#signatureArea',
          '[id*="hod"][id*="signature"]',
          '[id*="signature"][id*="area"]',
          '[id*="signature"][id*="hod"]',
          '.signature-area',
          '.hod-signature',
          'img[alt*="signature" i]',
          'img[id*="signature"]',
          'div[class*="signature"]',
          '*[id*="hodSignatureArea"]'
        ];


        let signatureInjected = false;
        let elementsFound = 0;


        signatureSelectors.forEach(selector => {
          const elements = doc.querySelectorAll(selector);
          if (elements.length > 0) {
            console.log(`ğŸ” Found ${elements.length} elements for selector: ${selector}`);
            elementsFound += elements.length;
          }

          elements.forEach((element, index) => {
            console.log(`ğŸ¯ Processing element ${index + 1} for selector: ${selector}`, element.tagName, element.id);

            if (element.tagName === 'IMG') {
              // Direct image element
              element.src = signatureUrl;
              element.style.display = 'block';
              element.style.maxHeight = '80px';
              element.style.maxWidth = '200px';
              element.style.border = '3px solid #28a745';
              element.style.borderRadius = '8px';
              element.style.padding = '8px';
              element.style.background = '#f8fff9';
              element.alt = 'HOD Digital Signature';
              signatureInjected = true;
              console.log('âœ… HOD signature injected into IMG element');
            } else {
              // Container element
              element.innerHTML = `
Â  Â  Â  Â  Â  Â  Â  Â  <div style="text-align: center; padding: 10px; border: 2px solid #28a745; border-radius: 8px; background: #f8fff9;">
Â  Â  Â  Â  Â  Â  Â  Â  Â  <img src="${signatureUrl}" 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â alt="HOD Digital Signature" 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â style="max-height: 80px; max-width: 200px; display: block; margin: 0 auto; 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  border: 2px solid #28a745; border-radius: 6px; padding: 5px; 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  background: white;">
Â  Â  Â  Â  Â  Â  Â  Â  Â  <div style="background: #d4edda; color: #155724; padding: 8px 12px; border-radius: 4px; 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  margin-top: 10px; font-weight: bold; font-size: 14px;">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  âœ… HOD Digital Signature Applied
Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  `;
              element.classList.add('has-signature');
              signatureInjected = true;
              console.log('âœ… HOD signature injected into container element');
            }
          });
        });


        console.log(`ğŸ” Total elements found: ${elementsFound}, Signature injected: ${signatureInjected}`);


        // If no specific containers found, try to find ANY element with text containing "signature"
        if (!signatureInjected) {
          console.log('âš ï¸ No specific containers found, trying fallback method...');

          const allElements = doc.querySelectorAll('div, span, p');
          allElements.forEach(element => {
            const text = element.textContent.toLowerCase();
            if ((text.includes('signature') && text.includes('hod')) ||
              (text.includes('upload') && text.includes('signature')) ||
              text.includes('click to upload hod signature')) {

              element.innerHTML = `
Â  Â  Â  Â  Â  Â  Â  Â  <div style="text-align: center; padding: 15px; border: 3px solid #28a745; border-radius: 8px; background: #f8fff9;">
Â  Â  Â  Â  Â  Â  Â  Â  Â  <img src="${signatureUrl}" 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â alt="HOD Digital Signature" 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â style="max-height: 80px; max-width: 200px; display: block; margin: 0 auto; 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  border: 2px solid #28a745; border-radius: 6px; padding: 8px; 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  background: white;">
Â  Â  Â  Â  Â  Â  Â  Â  Â  <div style="background: #d4edda; color: #155724; padding: 8px 12px; border-radius: 4px; 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  margin-top: 10px; font-weight: bold;">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  âœ… HOD Digital Signature Applied
Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  `;
              signatureInjected = true;
              console.log('âœ… HOD signature injected using fallback method');
            }
          });
        }


        if (signatureInjected) {
          iframe.classList.add('hod-signature-frame');
          console.log('âœ… HOD signature injection completed successfully');
        } else {
          console.log('âŒ HOD signature injection failed - no suitable containers found');

          // Last resort: create a new signature area at the end of the document
          const body = doc.body;
          if (body) {
            const signatureDiv = doc.createElement('div');
            signatureDiv.innerHTML = `
Â  Â  Â  Â  Â  Â  Â  <div style="text-align: center; padding: 20px; border: 3px solid #28a745; border-radius: 8px; 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  background: #f8fff9; margin: 20px 0;">
Â  Â  Â  Â  Â  Â  Â  Â  <h3 style="color: #155724; margin-bottom: 15px;">HOD Digital Signature</h3>
Â  Â  Â  Â  Â  Â  Â  Â  <img src="${signatureUrl}" 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â alt="HOD Digital Signature" 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â style="max-height: 80px; max-width: 200px; display: block; margin: 0 auto; 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  border: 2px solid #28a745; border-radius: 6px; padding: 8px; 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  background: white;">
Â  Â  Â  Â  Â  Â  Â  Â  <div style="background: #d4edda; color: #155724; padding: 8px 12px; border-radius: 4px; 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  margin-top: 10px; font-weight: bold;">
Â  Â  Â  Â  Â  Â  Â  Â  Â  âœ… HOD Digital Signature Applied
Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  `;
            body.appendChild(signatureDiv);
            signatureInjected = true;
            console.log('âœ… HOD signature injected using last resort method');
          }
        }


        return signatureInjected;


      } catch (error) {
        console.log('âŒ HOD signature injection failed:', error.message);
        return false;
      }
    }


    // âœ… FIXED: Enhanced table styling with more aggressive CSS
    function enhanceTableVisibility(iframe) {
      try {
        const doc = iframe.contentDocument || iframe.contentWindow.document;
        if (!doc) return;


        const style = doc.createElement('style');
        style.id = 'itReviewTableStyles';
        style.textContent = `
Â  Â  Â  Â  Â  /* AGGRESSIVE table styling - highest specificity */
Â  Â  Â  Â  Â  table, table.table, .table-container table {
Â  Â  Â  Â  Â  Â  width: 100% !important;
Â  Â  Â  Â  Â  Â  border-collapse: collapse !important;
Â  Â  Â  Â  Â  Â  margin: 20px 0 !important;
Â  Â  Â  Â  Â  Â  border: 3px solid #007bff !important;
Â  Â  Â  Â  Â  Â  background: white !important;
Â  Â  Â  Â  Â  Â  box-shadow: 0 4px 8px rgba(0,0,0,0.1) !important;
Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  th, td, table th, table td {
Â  Â  Â  Â  Â  Â  border: 2px solid #007bff !important;
Â  Â  Â  Â  Â  Â  padding: 15px 10px !important;
Â  Â  Â  Â  Â  Â  text-align: left !important;
Â  Â  Â  Â  Â  Â  vertical-align: top !important;
Â  Â  Â  Â  Â  Â  background: white !important;
Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  th, table th {
Â  Â  Â  Â  Â  Â  background: linear-gradient(135deg, #007bff 0%, #0056b3 100%) !important;
Â  Â  Â  Â  Â  Â  color: white !important;
Â  Â  Â  Â  Â  Â  font-weight: bold !important;
Â  Â  Â  Â  Â  Â  text-align: center !important;
Â  Â  Â  Â  Â  Â  font-size: 16px !important;
Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  td, table td {
Â  Â  Â  Â  Â  Â  background: #f8f9fa !important;
Â  Â  Â  Â  Â  Â  font-size: 14px !important;
Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  tr:nth-child(even) td {
Â  Â  Â  Â  Â  Â  background: #e9ecef !important;
Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  tr:hover td {
Â  Â  Â  Â  Â  Â  background: #fff3cd !important;
Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  /* Enhanced input visibility */
Â  Â  Â  Â  Â  table input, table select, table textarea {
Â  Â  Â  Â  Â  Â  width: 95% !important;
Â  Â  Â  Â  Â  Â  padding: 10px !important;
Â  Â  Â  Â  Â  Â  border: 2px solid #ced4da !important;
Â  Â  Â  Â  Â  Â  border-radius: 6px !important;
Â  Â  Â  Â  Â  Â  background: white !important;
Â  Â  Â  Â  Â  Â  font-size: 14px !important;
Â  Â  Â  Â  Â  Â  box-shadow: inset 0 1px 3px rgba(0,0,0,0.1) !important;
Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  table input:disabled, table select:disabled, table textarea:disabled {
Â  Â  Â  Â  Â  Â  background: #e9ecef !important;
Â  Â  Â  Â  Â  Â  border-color: #6c757d !important;
Â  Â  Â  Â  Â  Â  color: #495057 !important;
Â  Â  Â  Â  Â  Â  font-weight: bold !important;
Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  table input:focus, table select:focus, table textarea:focus {
Â  Â  Â  Â  Â  Â  border-color: #007bff !important;
Â  Â  Â  Â  Â  Â  box-shadow: 0 0 0 3px rgba(0,123,255,0.25) !important;
Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  /* Special styling for HOD fields */
Â  Â  Â  Â  Â  table input[id*="hod" i], table select[id*="hod" i], table textarea[id*="hod" i] {
Â  Â  Â  Â  Â  Â  background: linear-gradient(135deg, #d4edda 0%, #c3e6cb 100%) !important;
Â  Â  Â  Â  Â  Â  border-color: #28a745 !important;
Â  Â  Â  Â  Â  Â  color: #155724 !important;
Â  Â  Â  Â  Â  Â  font-weight: bold !important;
Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  /* Make sure tables are visible */
Â  Â  Â  Â  Â  .table-responsive, .table-container {
Â  Â  Â  Â  Â  Â  overflow-x: auto !important;
Â  Â  Â  Â  Â  Â  margin: 20px 0 !important;
Â  Â  Â  Â  Â  }
Â  Â  Â  Â  `;


        const target = doc.head || doc.body;
        if (target && !doc.querySelector('#itReviewTableStyles')) {
          target.appendChild(style);
          console.log('âœ… Enhanced table styles injected');

          // Force table visibility
          setTimeout(() => {
            const tables = doc.querySelectorAll('table');
            tables.forEach((table, index) => {
              table.style.display = 'table';
              table.style.visibility = 'visible';
              console.log(`âœ… Table ${index + 1} visibility forced`);
            });
          }, 500);
        }


      } catch (error) {
        console.log('âš ï¸ Table styling failed:', error.message);
      }
    }


    // âœ… Enhanced API blocking
    function disableIframeAPICall(iframe) {
      try {
        const iframeWindow = iframe.contentWindow;
        const iframeDoc = iframe.contentDocument || iframeWindow.document;


        // Direct function override
        if (iframeWindow && typeof iframeWindow.loadFormData === 'function') {
          iframeWindow.loadFormData = function () {
            console.log('ğŸš« Direct override: API call blocked');
            return Promise.resolve();
          };
        }


        // Script injection
        if (iframeDoc && !iframeDoc.querySelector('#itReviewBlocker')) {
          const script = iframeDoc.createElement('script');
          script.id = 'itReviewBlocker';
          const timestamp = Date.now();


          script.textContent = `
Â  Â  Â  Â  Â  Â  (function() {
Â  Â  Â  Â  Â  Â  Â  console.log('ğŸ”§ IT Review: API blocking script');
Â  Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  Â  if (typeof window.loadFormData === 'function') {
Â  Â  Â  Â  Â  Â  Â  Â  window.loadFormData = function() {
Â  Â  Â  Â  Â  Â  Â  Â  Â  console.log('ğŸš« loadFormData blocked');
Â  Â  Â  Â  Â  Â  Â  Â  Â  return Promise.resolve();
Â  Â  Â  Â  Â  Â  Â  Â  };
Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  Â  if (!window.__itFetchBlocked_${timestamp}) {
Â  Â  Â  Â  Â  Â  Â  Â  const origFetch = window.fetch;
Â  Â  Â  Â  Â  Â  Â  Â  window.fetch = function(url, options) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  if (typeof url === 'string' && (
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  url.includes('/api/employee/form-data') || 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  url.includes('/api/hod/form-details')
Â  Â  Â  Â  Â  Â  Â  Â  Â  )) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  console.log('ğŸš« Fetch blocked:', url);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  return Promise.reject(new Error('API blocked by IT review'));
Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  Â  return origFetch.apply(this, arguments);
Â  Â  Â  Â  Â  Â  Â  Â  };
Â  Â  Â  Â  Â  Â  Â  Â  window.__itFetchBlocked_${timestamp} = true;
Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  Â  window.userRole = 'it';
Â  Â  Â  Â  Â  Â  })();
Â  Â  Â  Â  Â  `;


          const target = iframeDoc.head || iframeDoc.body || iframeDoc.documentElement;
          if (target) {
            target.appendChild(script);
            console.log('âœ… API blocking script injected');
          }
        }


        return true;
      } catch (error) {
        console.log('âš ï¸ API blocking failed silently');
        return false;
      }
    }


    // âœ… FIXED: Enhanced form data loading with proper HOD signature extraction
    async function loadFormData() {
      try {
        showStatus('Loading forms with complete employee and HOD details...', 'loading');


        const response = await fetch(`/api/itadmin/form-details/${formId}`, {
          credentials: 'include'
        });


        if (!response.ok) {
          throw new Error(`Server responded with ${response.status}`);
        }


        const data = await response.json();


        if (!data.success) {
          throw new Error(data.message || 'Failed to load form data');
        }


        formData = data;
        console.log('âœ… Complete form data loaded:', data);


        // Show debug info temporarily
        showDebugInfo(data);


        // âœ… FIXED: Extract HOD signature from the CORRECT location
        if (data.hodApproval) {
          hodApprovalData = data.hodApproval;
          console.log('ğŸ“‹ HOD Approval Data:', hodApprovalData);

          // Check for signature in hodApproval object
          const possibleSignatureFields = [
            'signature',
            'hodSignature',
            'signatureDataUrl',
            'signatureUrl',
            'digitalSignature'
          ];

          possibleSignatureFields.forEach(field => {
            if (hodApprovalData[field] && !hodSignatureUrl) {
              hodSignatureUrl = hodApprovalData[field];
              console.log(`âœ… HOD signature found in hodApproval.${field}:`, hodSignatureUrl.substring(0, 50) + '...');
            }
          });
        }


        // Also check in forms as fallback
        if (!hodSignatureUrl && data.forms) {
          Object.values(data.forms).forEach(form => {
            if (form) {
              const possibleSignatureFields = [
                'hodSignature',
                'signatureDataUrl',
                'signature'
              ];

              possibleSignatureFields.forEach(field => {
                if (form[field] && !hodSignatureUrl) {
                  hodSignatureUrl = form[field];
                  console.log(`âœ… HOD signature found in forms.${field}`);
                }
              });
            }
          });
        }


        console.log('ğŸ” Final HOD Signature URL:', hodSignatureUrl ? 'Available (' + hodSignatureUrl.length + ' chars)' : 'Not found');


        // Display information and setup forms
        displayEmployeeInfo(data.employee);
        displayHODInfo(data.hodApproval);
        setupCompleteFormsView(data.forms, data.noDuesType);


        hideStatus();


      } catch (error) {
        console.error('Error loading form data:', error);
        showStatus(`Failed to load form data: ${error.message}`, 'error');
      }
    }


    // Display employee information
    function displayEmployeeInfo(employee) {
      $('employeeInfo').innerHTML = `
Â  Â  Â  Â  <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  background: #f8f9fa; padding: 15px; border-radius: 8px; border: 1px solid #dee2e6;">
Â  Â  Â  Â  Â  <div><strong>Name:</strong> ${employee.name}</div>
Â  Â  Â  Â  Â  <div><strong>Employee ID:</strong> ${employee.employeeId}</div>
Â  Â  Â  Â  Â  <div><strong>Department:</strong> ${employee.department}</div>
Â  Â  Â  Â  </div>
Â  Â  Â  `;
    }


    // âœ… Display HOD approval information
    function displayHODInfo(hodApproval) {
      if (!hodApproval) {
        $('hodInfo').innerHTML = '<p>âŒ No HOD approval data available</p>';
        return;
      }


      $('hodInfo').innerHTML = `
Â  Â  Â  Â  <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
Â  Â  Â  Â  Â  <div><strong>Approved By:</strong> ${hodApproval.approvedBy || 'N/A'}</div>
Â  Â  Â  Â  Â  <div><strong>HOD Employee ID:</strong> ${hodApproval.approverEmployeeId || 'N/A'}</div>
Â  Â  Â  Â  Â  <div><strong>HOD Email:</strong> ${hodApproval.approverEmail || 'N/A'}</div>
Â  Â  Â  Â  Â  <div><strong>Department:</strong> ${hodApproval.approverDepartment || 'N/A'}</div>
Â  Â  Â  Â  Â  <div><strong>Approval Date:</strong> ${hodApproval.approvalDate ? new Date(hodApproval.approvalDate).toLocaleString() : 'N/A'}</div>
Â  Â  Â  Â  Â  <div><strong>Signature:</strong> ${hodSignatureUrl ? 'âœ… Available (' + hodSignatureUrl.length + ' chars)' : 'âŒ Not found'}</div>
Â  Â  Â  Â  </div>
Â  Â  Â  Â  ${hodApproval.remarks ? `<div style="margin-top: 10px;"><strong>HOD Remarks:</strong> ${hodApproval.remarks}</div>` : ''}
Â  Â  Â  `;
    }


    // âœ… Enhanced form setup with better timing
    function setupCompleteFormsView(forms, noDuesType) {
      const framesToLoad = [
        {
          frameId: 'disposalFrame',
          url: 'forms/disposalform.html',
          key: 'disposalForm'
        },
        {
          frameId: 'efileFrame',
          url: 'forms/efile.html',
          key: 'efileForm'
        },
        {
          frameId: 'form365Frame',
          url: noDuesType === 'Transfer' ? 'forms/form365transfer.html' : 'forms/form365disposal.html',
          key: noDuesType === 'Transfer' ? 'form365Trans' : 'form365Disp'
        }
      ];


      framesToLoad.forEach((frameInfo, index) => {
        const frame = $(frameInfo.frameId);


        frame.src = `${frameInfo.url}?role=it&formId=${encodeURIComponent(formId)}&skipLoad=true&itReview=true&hasSignature=${hodSignatureUrl ? 'true' : 'false'}&timestamp=${Date.now()}`;
        frame.dataset.formKey = frameInfo.key;


        frame.onload = () => {
          console.log(`âœ… Loading form view for IT review: ${frameInfo.key}`);


          const delay = 1200 + (index * 500); // Longer delays
          setTimeout(() => {
            disableIframeAPICall(frame);
            enhanceTableVisibility(frame);


            setTimeout(() => {
              populateFormWithAllData(frame, forms[frameInfo.key]);

              // Inject HOD signature with even longer delay
              setTimeout(() => {
                if (hodSignatureUrl) {
                  console.log(`ğŸ” Attempting to inject HOD signature into ${frameInfo.key}...`);
                  const success = injectHODSignature(frame, hodSignatureUrl);
                  console.log(`${success ? 'âœ…' : 'âŒ'} HOD signature injection result for ${frameInfo.key}: ${success}`);
                } else {
                  console.log(`âš ï¸ No HOD signature URL available for ${frameInfo.key}`);
                }
              }, 1000);
            }, 800);
          }, delay);
        };
      });
    }


    // âœ… Enhanced form population with HOD data integration
    function populateFormWithAllData(iframe, formData) {
      if (!formData) {
        console.log('No form data available for population');
        return;
      }


      try {
        const doc = iframe.contentDocument || iframe.contentWindow.document;
        if (!doc) {
          console.log('Cannot access iframe document');
          return;
        }


        console.log('ğŸ”„ Populating form with data:', Object.keys(formData));


        // Combine form data with HOD approval data
        const allData = { ...formData };

        if (hodApprovalData) {
          // Add HOD data with appropriate field names
          allData.hodName = hodApprovalData.approvedBy;
          allData.hodEmployeeId = hodApprovalData.approverEmployeeId;
          allData.hodEmail = hodApprovalData.approverEmail;
          allData.hodDepartment = hodApprovalData.approverDepartment;
          allData.hodDesignation = hodApprovalData.approverDesignation;
          allData.hodApprovalDate = hodApprovalData.approvalDate;
          allData.hodRemarks = hodApprovalData.remarks;
          allData.hodSignature = hodSignatureUrl;
          allData.hodSignatureArea = hodSignatureUrl;

          console.log('ğŸ“ Added HOD data to form population');
        }


        // Populate ALL form fields
        Object.entries(allData).forEach(([fieldId, value]) => {
          if (!value) return;


          const element = doc.getElementById(fieldId);
          if (!element) return;


          const tagName = element.tagName.toLowerCase();


          if (tagName === 'input' || tagName === 'select' || tagName === 'textarea') {
            element.value = value;
            element.disabled = true;


            if (fieldId.toLowerCase().includes('hod')) {
              element.style.backgroundColor = '#d4edda';
              element.style.border = '2px solid #28a745';
              element.style.fontWeight = 'bold';
              element.style.color = '#155724';
            }
          } else if (tagName === 'img') {
            if (value && value.trim()) {
              element.src = value;
              element.style.display = 'block';


              if (fieldId.toLowerCase().includes('hod') && fieldId.toLowerCase().includes('signature')) {
                element.style.border = '3px solid #28a745';
                element.style.borderRadius = '8px';
                element.style.padding = '8px';
                element.style.backgroundColor = '#f8fff9';
                element.style.maxHeight = '80px';
                element.style.maxWidth = '200px';
                console.log('âœ… HOD signature image populated:', fieldId);
              }
            }
          } else {
            element.textContent = value;


            if (fieldId.toLowerCase().includes('hod')) {
              element.style.backgroundColor = '#d4edda';
              element.style.padding = '4px 8px';
              element.style.borderRadius = '4px';
              element.style.fontWeight = 'bold';
              element.style.border = '1px solid #28a745';
              element.style.color = '#155724';
            }
          }
        });


        console.log('âœ… Form population completed');


      } catch (error) {
        console.log('Form population had issues but continuing:', error.message);
      }
    }


    // Handle IT signature upload
    $('itSignatureFile').onchange = function (event) {
      const file = event.target.files[0];
      if (!file) return;


      const reader = new FileReader();
      reader.onload = function (e) {
        itSignatureData = e.target.result;
        const preview = $('itSignaturePreview');
        preview.src = itSignatureData;
        preview.style.display = 'block';
        updateButtonStates();
      };
      reader.readAsDataURL(file);
    };


    // Update button states based on form completion
    function updateButtonStates() {
      const name = $('itOfficerName').value.trim();
      const id = $('itOfficerId').value.trim();
      const email = $('itEmail').value.trim();
      const decision = $('itDecision').value;
      const hasSignature = !!itSignatureData;


      const isFormComplete = name && id && email && decision && hasSignature;


      $('completeBtn').disabled = !isFormComplete || decision !== 'approved';
      $('rejectBtn').disabled = !isFormComplete || decision !== 'rejected';
    }


    // Attach event listeners for form validation
    ['itOfficerName', 'itOfficerId', 'itEmail', 'itDecision'].forEach(fieldId => {
      $(fieldId).addEventListener('input', updateButtonStates);
      $(fieldId).addEventListener('change', updateButtonStates);
    });


    // Complete clearance
    $('completeBtn').onclick = async function () {
      if (this.disabled) return;


      if (!confirm('Are you sure you want to complete this clearance? This action cannot be undone.')) {
        return;
      }


      await processITDecision('complete');
    };


    // Reject clearance
    $('rejectBtn').onclick = async function () {
      if (this.disabled) return;


      const remarks = $('itRemarks').value.trim();
      if (!remarks) {
        alert('Please provide remarks for rejection.');
        $('itRemarks').focus();
        return;
      }


      if (!confirm('Are you sure you want to reject this clearance? It will be returned to the employee.')) {
        return;
      }


      await processITDecision('reject');
    };


    // Process IT decision
    async function processITDecision(action) {
      try {
        showStatus(`${action === 'complete' ? 'Completing' : 'Rejecting'} clearance...`, 'loading');


        const allFormData = {};
        const iframes = document.querySelectorAll('iframe[data-form-key]');


        for (const iframe of iframes) {
          const key = iframe.dataset.formKey;
          const doc = iframe.contentDocument || iframe.contentWindow.document;
          const data = {};


          if (doc) {
            doc.querySelectorAll('[id]').forEach(el => {
              if (['INPUT', 'SELECT', 'TEXTAREA'].includes(el.tagName)) {
                data[el.id] = el.value;
              } else if (el.tagName === 'IMG') {
                data[el.id] = el.src;
              } else {
                data[el.id] = el.textContent.trim();
              }
            });
          }


          // Add IT approval data
          data.itOfficerName = $('itOfficerName').value;
          data.itOfficerId = $('itOfficerId').value;
          data.itEmail = $('itEmail').value;
          data.itDecision = $('itDecision').value;
          data.itSignature = itSignatureData;
          data.itRemarks = $('itRemarks').value;
          data.itProcessedDate = new Date().toISOString();


          allFormData[key] = data;
        }


        const payload = {
          formId,
          formResponses: allFormData,
          action,
          remarks: $('itRemarks').value
        };


        console.log('Submitting IT decision:', payload);


        const response = await fetch('/api/itadmin/final-process', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          credentials: 'include',
          body: JSON.stringify(payload)
        });


        const result = await response.json();
        console.log('IT processing result:', result);


        if (response.ok && result.success) {
          showStatus(
            action === 'complete'
              ? 'âœ… Clearance completed successfully!'
              : 'âŒ Clearance rejected and returned',
            'success'
          );


          $('completeBtn').disabled = true;
          $('rejectBtn').disabled = true;


          setTimeout(() => {
            window.close();
          }, 3000);


        } else {
          throw new Error(result.message || 'Processing failed');
        }


      } catch (error) {
        console.error('IT processing error:', error);
        showStatus(`âŒ Error: ${error.message}`, 'error');
      }
    }


    // Initialize on page load
    window.addEventListener('DOMContentLoaded', loadFormData);
  </script>
</body>


</html>