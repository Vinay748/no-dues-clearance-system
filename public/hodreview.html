<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <title>HOD Review Dashboard</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 0;
      background: #f0f0f0;
      color: #333;
    }

    /* Header */
    .header {
      background: #336699;
      color: white;
      padding: 15px 20px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .header h1 {
      margin: 0;
      font-size: 20px;
    }

    .header-right {
      display: flex;
      align-items: center;
      gap: 15px;
    }

    .header span {
      font-size: 14px;
    }

    /* Hamburger Menu Button */
    .menu-button {
      background: none;
      border: none;
      color: white;
      cursor: pointer;
      padding: 5px;
      position: relative;
    }

    .hamburger {
      display: flex;
      flex-direction: column;
      width: 20px;
      height: 16px;
      justify-content: space-between;
    }

    .hamburger span {
      display: block;
      height: 2px;
      width: 100%;
      background: white;
      border-radius: 1px;
    }

    /* Dropdown Menu */
    .menu-dropdown {
      position: absolute;
      top: 100%;
      right: 0;
      background: white;
      border: 1px solid #ccc;
      border-radius: 5px;
      min-width: 160px;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
      z-index: 1000;
      display: none;
      overflow: hidden;
    }

    .menu-dropdown.show {
      display: block;
    }

    .menu-item {
      padding: 12px 16px;
      color: #333;
      text-decoration: none;
      display: block;
      border-bottom: 1px solid #eee;
      cursor: pointer;
      font-size: 13px;
    }

    .menu-item:last-child {
      border-bottom: none;
    }

    .menu-item:hover {
      background: #f5f5f5;
    }

    .menu-item.logout:hover {
      background: #ffe6e6;
      color: #d32f2f;
    }

    /* Main */
    .main {
      max-width: 1000px;
      margin: 20px auto;
      padding: 0 20px;
    }

    /* Profile */
    .profile {
      background: white;
      padding: 20px;
      margin-bottom: 20px;
      border: 1px solid #ccc;
      display: flex;
      align-items: center;
      gap: 15px;
    }

    .profile-icon {
      width: 40px;
      height: 40px;
      background: #666;
      color: white;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: bold;
      cursor: pointer;
      position: relative;
    }

    /* Profile Dropdown */
    .profile-dropdown {
      position: absolute;
      top: 45px;
      right: 0;
      background: white;
      border: 1px solid #ccc;
      border-radius: 5px;
      padding: 10px;
      min-width: 200px;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
      z-index: 1000;
      display: none;
    }

    .profile-dropdown.show {
      display: block;
    }

    .profile-dropdown p {
      margin: 5px 0;
      font-size: 12px;
      color: #666;
    }

    .profile-info h3 {
      margin: 0;
      font-size: 16px;
    }

    /* Enhanced Stats Tabs with Numbers on Top */
    .stats {
      background: white;
      border: 1px solid #ccc;
      margin-bottom: 20px;
    }

    .stats-tabs {
      display: flex;
      border-bottom: 1px solid #ccc;
    }

    .stats-tabs button {
      flex: 1;
      padding: 10px;
      background: none;
      border: none;
      cursor: pointer;
      font-size: 13px;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 3px;
      transition: background-color 0.3s ease;
    }

    .stats-tabs button:hover {
      background: #f0f0f0;
    }

    .stats-tabs button.active {
      background: #e0e0e0;
      border-bottom: 3px solid #336699;
    }

    /* Numbers on TOP of words */
    .tab-count {
      font-size: 18px;
      font-weight: bold;
      color: #666;
      order: 1;
    }

    .tab-label {
      font-weight: bold;
      order: 2;
    }

    .stats-tabs button.active .tab-count {
      color: #336699;
    }

    /* Different colors for different tab counts */
    .stats-tabs button[data-type="pending"] .tab-count {
      color: #ff9800;
    }

    .stats-tabs button[data-type="approved"] .tab-count {
      color: #4caf50;
    }

    .stats-tabs button[data-type="rejected"] .tab-count {
      color: #f44336;
    }

    .stats-tabs button[data-type="total"] .tab-count {
      color: #2196f3;
    }

    /* Table */
    .table-section {
      background: white;
      border: 1px solid #ccc;
    }

    .table-header {
      padding: 15px 20px;
      background: #f5f5f5;
      border-bottom: 1px solid #ccc;
      display: flex;
      justify-content: space-between;
    }

    .table-header h2 {
      margin: 0;
      font-size: 16px;
    }

    .refresh-btn {
      background: #336699;
      color: white;
      border: none;
      padding: 5px 10px;
      cursor: pointer;
      font-size: 12px;
      border-radius: 3px;
    }

    .refresh-btn:hover {
      background: #2c5282;
    }

    table {
      width: 100%;
      border-collapse: collapse;
    }

    th,
    td {
      padding: 10px;
      text-align: left;
      border-bottom: 1px solid #eee;
    }

    th {
      background: #f0f0f0;
      font-size: 12px;
      font-weight: bold;
    }

    tr:hover {
      background: #f9f9f9;
    }

    .btn {
      padding: 4px 8px;
      border: none;
      cursor: pointer;
      font-size: 11px;
      margin-right: 3px;
      border-radius: 3px;
    }

    /* Dark Blue Review Button */
    .btn-review {
      background: #1a365d;
      color: white;
    }

    .btn-review:hover {
      background: #2c5282;
    }

    .btn-reject {
      background: white;
      color: #f44336;
      border: 1px solid #f44336;
    }

    .btn-reject:hover {
      background: #f44336;
      color: white;
    }

    .btn-view {
      background: #17a2b8;
      color: white;
      border: 1px solid #17a2b8;
    }

    .btn-view:hover {
      background: #138496;
      border-color: #138496;
    }

    /* Status badges */
    .status-badge {
      padding: 2px 6px;
      border-radius: 12px;
      font-size: 10px;
      font-weight: bold;
      text-transform: uppercase;
    }

    .status-pending {
      background: #fff3cd;
      color: #856404;
    }

    .status-approved {
      background: #d4edda;
      color: #155724;
    }

    .status-rejected {
      background: #f8d7da;
      color: #721c24;
    }

    .status-completed {
      background: #e7f3ff;
      color: #0056b3;
      border: 1px solid #0056b3;
    }

    /* Modal */
    .modal-overlay {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.5);
      z-index: 2000;
    }

    .modal {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: white;
      border: 1px solid #ccc;
      width: 400px;
      border-radius: 8px;
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
    }

    .modal h3 {
      margin: 0;
      padding: 15px 20px;
      background: #f5f5f5;
      border-bottom: 1px solid #ccc;
      font-size: 14px;
      border-radius: 8px 8px 0 0;
    }

    .modal-body {
      padding: 20px;
    }

    .modal textarea {
      width: 100%;
      height: 60px;
      border: 1px solid #ccc;
      padding: 5px;
      font-family: Arial, sans-serif;
      border-radius: 4px;
      resize: vertical;
    }

    .modal-footer {
      padding: 15px 20px;
      text-align: right;
      background: #f5f5f5;
      border-top: 1px solid #ccc;
      border-radius: 0 0 8px 8px;
    }

    .modal-footer button {
      padding: 6px 12px;
      border: none;
      cursor: pointer;
      margin-left: 5px;
      border-radius: 4px;
    }

    .modal-cancel {
      background: #ccc;
      color: #333;
    }

    .modal-cancel:hover {
      background: #bbb;
    }

    .modal-submit {
      background: #f44336;
      color: white;
    }

    .modal-submit:hover {
      background: #d32f2f;
    }

    .hidden {
      display: none;
    }

    /* Empty state */
    .empty-state {
      text-align: center;
      padding: 40px 20px;
      color: #666;
    }

    /* Mobile */
    @media (max-width: 600px) {
      .header {
        flex-direction: column;
        gap: 10px;
      }

      .header-right {
        align-self: flex-end;
      }

      .stats-tabs {
        flex-wrap: wrap;
      }

      .stats-tabs button {
        flex: 1 1 50%;
      }

      table {
        font-size: 12px;
      }

      th,
      td {
        padding: 6px;
      }

      .tab-count {
        font-size: 16px;
      }

      .profile-dropdown {
        right: -10px;
        width: 180px;
      }

      .menu-dropdown {
        right: 0;
        min-width: 140px;
      }

      .modal {
        width: 90%;
        max-width: 400px;
      }
    }
  </style>
</head>

<body>
  <!-- Header with Hamburger Menu -->
  <div class="header">
    <h1>HOD Dashboard</h1>
    <div class="header-right">
      <span id="currentTime"></span>
      <div class="menu-button" onclick="toggleMenu()">
        <div class="hamburger">
          <span></span>
          <span></span>
          <span></span>
        </div>
        <div class="menu-dropdown" id="menuDropdown">
          <a href="#" class="menu-item" onclick="changePassword()">Change Password</a>
          <a href="#" class="menu-item" onclick="openSettings()">Settings</a>
          <a href="#" class="menu-item logout" onclick="logout()">Logout</a>
        </div>
      </div>
    </div>
  </div>

  <div class="main">
    <!-- Profile with Clickable Icon -->
    <div class="profile">
      <div class="profile-icon" id="profileIcon" onclick="toggleProfileDropdown()">
        S
        <div class="profile-dropdown" id="profileDropdown">
          <p><strong>Password:</strong> <span id="profilePassword">••••••••</span></p>
          <p><strong>Email:</strong> <span id="profileEmail">Loading...</span></p>
        </div>
      </div>
      <div class="profile-info">
        <h3 id="profileName">Sushil Kumar Uniyal</h3>
      </div>
    </div>

    <!-- Enhanced Stats with Numbers on TOP and WORKING TABS -->
    <div class="stats">
      <div class="stats-tabs">
        <button class="active" data-type="pending" onclick="switchTab('pending', this)">
          <span class="tab-count" id="pendingTabCount">0</span>
          <span class="tab-label">Pending</span>
        </button>
        <button data-type="approved" onclick="switchTab('approved', this)">
          <span class="tab-count" id="approvedTabCount">0</span>
          <span class="tab-label">Approved</span>
        </button>
        <button data-type="rejected" onclick="switchTab('rejected', this)">
          <span class="tab-count" id="rejectedTabCount">0</span>
          <span class="tab-label">Rejected</span>
        </button>
        <button data-type="total" onclick="switchTab('total', this)">
          <span class="tab-count" id="totalTabCount">0</span>
          <span class="tab-label">Total</span>
        </button>
      </div>
    </div>

    <!-- Table with Name instead of Form ID -->
    <div class="table-section">
      <div class="table-header">
        <h2 id="tableTitle">Pending Applications</h2>
        <button class="refresh-btn" onclick="loadData()">Refresh</button>
      </div>

      <table>
        <thead>
          <tr>
            <th>Employee Name</th>
            <th>Form ID</th>
            <th>Department</th>
            <th>Date</th>
            <th>Status</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody id="tableBody">
          <tr>
            <td colspan="6" style="text-align: center; padding: 40px;">Loading...</td>
          </tr>
        </tbody>
      </table>
    </div>
  </div>

  <!-- Modal -->
  <div class="modal-overlay" id="modalOverlay" onclick="closeModalOnOverlay(event)">
    <div class="modal">
      <h3>Reject Application</h3>
      <div class="modal-body">
        <textarea id="rejectReason" placeholder="Enter detailed reason for rejection..."></textarea>
      </div>
      <div class="modal-footer">
        <button class="modal-cancel" onclick="closeModal()">Cancel</button>
        <button class="modal-submit" onclick="submitReject()">Submit Rejection</button>
      </div>
    </div>
  </div>

  <script>
    let selectedForm = null;
    let applications = [];
    let currentTab = 'pending';

    // Initialize
    window.onload = function () {
      loadProfile();
      loadData();
      updateTime();
      setInterval(updateTime, 1000);

      // Close dropdowns when clicking outside
      document.addEventListener('click', function (event) {
        if (!event.target.closest('.profile-icon')) {
          document.getElementById('profileDropdown').classList.remove('show');
        }
        if (!event.target.closest('.menu-button')) {
          document.getElementById('menuDropdown').classList.remove('show');
        }
      });
    };

    // Tab switching functionality
    function switchTab(tabType, buttonElement) {
      currentTab = tabType;

      // Remove active class from all tabs
      document.querySelectorAll('.stats-tabs button').forEach(btn => {
        btn.classList.remove('active');
      });

      // Add active class to clicked tab
      buttonElement.classList.add('active');

      // Update table title
      const titles = {
        'pending': 'Pending Applications',
        'approved': 'Approved Applications',
        'rejected': 'Rejected Applications',
        'total': 'All Applications'
      };

      document.getElementById('tableTitle').textContent = titles[tabType] || 'Applications';

      filterAndDisplayApplications(tabType);
    }

    // Filter applications by status
    function filterAndDisplayApplications(tabType) {
      let filteredApps = [];

      switch (tabType) {
        case 'pending':
          filteredApps = applications.filter(app => {
            const status = (app.status || '').toLowerCase();
            return status === 'submitted to hod' ||
              status === 'pending' ||
              status === 'submitted' ||
              status === 'awaiting review' ||
              status === 'under review' ||
              status === '' ||
              !app.status;
          });
          break;

        case 'approved':
          filteredApps = applications.filter(app => {
            const status = (app.status || '').toLowerCase();
            return status === 'approved' ||
              status === 'approved by hod' ||
              status === 'submitted to it' ||
              status.includes('approved');
          });
          break;

        case 'rejected':
          filteredApps = applications.filter(app => {
            const status = (app.status || '').toLowerCase();
            return status === 'rejected' ||
              status === 'rejected by hod' ||
              status.includes('rejected');
          });
          break;

        case 'total':
        default:
          filteredApps = applications;
          break;
      }

      updateTableWithData(filteredApps, tabType);
    }

    // Table with status-based action controls
    function updateTableWithData(apps, tabType) {
      const tbody = document.getElementById('tableBody');
      tbody.innerHTML = '';

      if (!apps || apps.length === 0) {
        tbody.innerHTML = `
          <tr>
            <td colspan="6" class="empty-state">
              No ${tabType === 'total' ? '' : tabType} applications found
            </td>
          </tr>
        `;
        return;
      }

      apps.forEach(app => {
        const status = app.status || 'Pending';
        const statusLower = status.toLowerCase();

        let statusClass = 'status-pending';
        if (statusLower === 'approved' || statusLower.includes('approved') || statusLower === 'submitted to it') {
          statusClass = 'status-approved';
        } else if (statusLower === 'rejected' || statusLower.includes('rejected')) {
          statusClass = 'status-rejected';
        }

        // Determine if form is actionable (pending) or view-only (approved/rejected)
        const isPending = statusLower === 'submitted to hod' ||
          statusLower === 'pending' ||
          statusLower === 'submitted' ||
          statusLower.includes('awaiting') ||
          statusLower.includes('under review') ||
          statusLower === '' ||
          !app.status;

        const isApproved = statusLower.includes('approved') || statusLower === 'submitted to it';
        const isRejected = statusLower.includes('rejected');

        // Action buttons based on status
        let actionButtons = '';
        if (isPending) {
          // Pending forms: Full action buttons (Review + Reject)
          actionButtons = `
            <button class="btn btn-review" onclick="reviewApp('${app.formId}', 'pending')" title="Review and take action">Review</button>
            <button class="btn btn-reject" onclick="openModal('${app.formId}')" title="Reject application">Reject</button>
          `;
        } else if (isApproved) {
          // Approved forms: View-only button
          actionButtons = `
            <button class="btn btn-view" onclick="reviewApp('${app.formId}', 'approved')" title="View approved form (read-only)">View Details</button>
          `;
        } else if (isRejected) {
          // Rejected forms: View-only button
          actionButtons = `
            <button class="btn btn-view" onclick="reviewApp('${app.formId}', 'rejected')" title="View rejected form (read-only)">View Details</button>
          `;
        } else {
          // Default: View button
          actionButtons = `
            <button class="btn btn-view" onclick="reviewApp('${app.formId}', 'view')" title="View form details">View</button>
          `;
        }

        const row = document.createElement('tr');
        row.innerHTML = `
          <td><strong>${app.name || app.employeeName || 'N/A'}</strong></td>
          <td>${app.formId}</td>
          <td>${app.department || 'N/A'}</td>
          <td>${app.submissionDate ? new Date(app.submissionDate).toLocaleDateString() :
            app.lastUpdated ? new Date(app.lastUpdated).toLocaleDateString() : 'N/A'}</td>
          <td><span class="status-badge ${statusClass}">${status}</span></td>
          <td>${actionButtons}</td>
        `;
        tbody.appendChild(row);
      });
    }

    function updateTime() {
      document.getElementById('currentTime').textContent = new Date().toLocaleTimeString();
    }

    function toggleMenu() {
      const dropdown = document.getElementById('menuDropdown');
      dropdown.classList.toggle('show');
    }

    function changePassword() {
      document.getElementById('menuDropdown').classList.remove('show');
      alert('Change Password feature - This would open a password change dialog');
    }

    function openSettings() {
      document.getElementById('menuDropdown').classList.remove('show');
      alert('Settings feature - This would open a settings page');
    }

    function logout() {
      document.getElementById('menuDropdown').classList.remove('show');
      if (confirm('Are you sure you want to logout?')) {
        fetch('/api/auth/logout', {
          method: 'POST',
          credentials: 'include'
        }).then(() => {
          window.location.href = '/login.html';
        }).catch(() => {
          window.location.href = '/login.html';
        });
      }
    }

    function toggleProfileDropdown() {
      const dropdown = document.getElementById('profileDropdown');
      dropdown.classList.toggle('show');
    }

    async function loadProfile() {
      try {
        const response = await fetch('/api/hod/profile', { credentials: 'include' });
        const data = await response.json();

        if (data.success) {
          document.getElementById('profileName').textContent = 'Sushil Kumar Uniyal';
          document.getElementById('profileEmail').textContent = data.hodData.email;
        }
      } catch (e) {
        document.getElementById('profileName').textContent = 'Sushil Kumar Uniyal';
        document.getElementById('profileEmail').textContent = 'sushil.unoyal@company.com';
      }
    }

    // Load data from API with correct endpoint priority
    async function loadData() {
      try {
        const endpoints = [
          '/api/hod/all',
          '/api/hod/applications',
          '/api/hod/forms',
          '/api/hod/pending'
        ];

        let data = null;
        let response = null;

        // Try each endpoint until one works
        for (const endpoint of endpoints) {
          try {
            response = await fetch(endpoint, {
              credentials: 'include',
              headers: {
                'Accept': 'application/json',
                'Content-Type': 'application/json'
              }
            });

            if (response.ok) {
              data = await response.json();
              break;
            }
          } catch (e) {
            continue;
          }
        }

        if (!data) {
          throw new Error('All API endpoints failed');
        }

        // Handle different response formats
        let responseData = null;
        if (data.success && data.data) {
          responseData = data.data;
        } else if (data.success && data.list) {
          responseData = data.list;
        } else if (data.success && data.applications) {
          responseData = data.applications;
        } else if (data.success && data.forms) {
          responseData = data.forms;
        } else if (Array.isArray(data)) {
          responseData = data;
        } else if (data.success && Array.isArray(data.pending)) {
          responseData = data.pending;
        } else {
          responseData = [];
        }

        applications = responseData || [];

        updateTabCounts();
        filterAndDisplayApplications(currentTab);

      } catch (e) {
        applications = [];
        updateTabCounts();
        document.getElementById('tableBody').innerHTML =
          `<tr><td colspan="6" class="empty-state">
             Error loading data. Please refresh the page.
           </td></tr>`;
      }
    }

    // Tab counts with improved status detection
    function updateTabCounts() {
      const pending = applications.filter(app => {
        const status = (app.status || '').toLowerCase();
        return status === 'submitted to hod' ||
          status === 'pending' ||
          status === 'submitted' ||
          status === 'awaiting review' ||
          status === 'under review' ||
          status === '' ||
          !app.status;
      }).length;

      const approved = applications.filter(app => {
        const status = (app.status || '').toLowerCase();
        return status === 'approved' ||
          status === 'submitted to it' ||
          status.includes('approved');
      }).length;

      const rejected = applications.filter(app => {
        const status = (app.status || '').toLowerCase();
        return status === 'rejected' ||
          status.includes('rejected');
      }).length;

      const total = applications.length;

      // Update tab counts
      document.getElementById('pendingTabCount').textContent = pending;
      document.getElementById('approvedTabCount').textContent = approved;
      document.getElementById('rejectedTabCount').textContent = rejected;
      document.getElementById('totalTabCount').textContent = total;
    }

    // Review function with mode parameter
    function reviewApp(formId, mode = 'pending') {
      // Add mode parameter to URL so hod-form-review.html knows the status
      window.location.href = `/hod-form-review.html?formId=${formId}&mode=${mode}`;
    }

    function openModal(formId) {
      selectedForm = formId;
      document.getElementById('modalOverlay').style.display = 'block';
      document.getElementById('rejectReason').focus();
    }

    function closeModal() {
      selectedForm = null;
      document.getElementById('rejectReason').value = '';
      document.getElementById('modalOverlay').style.display = 'none';
    }

    function closeModalOnOverlay(event) {
      if (event.target === event.currentTarget) {
        closeModal();
      }
    }

    async function submitReject() {
      const reason = document.getElementById('rejectReason').value.trim();
      if (!reason) {
        alert('Please enter a reason for rejection');
        return;
      }

      if (reason.length < 10) {
        alert('Please provide a more detailed reason (minimum 10 characters)');
        return;
      }

      try {
        const response = await fetch('/api/hod/approve-form', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          credentials: 'include',
          body: JSON.stringify({
            formId: selectedForm,
            action: 'rejected',
            remarks: reason
          })
        });

        const result = await response.json();
        if (result.success) {
          alert('Application rejected successfully');
          closeModal();
          loadData(); // Reload data to update counts and table
        } else {
          alert('Error: ' + (result.message || 'Failed to reject application'));
        }
      } catch (e) {
        alert('Network error. Please try again.');
      }
    }

    // Auto refresh every 2 minutes
    setInterval(loadData, 120000);

    // Keyboard shortcuts
    document.addEventListener('keydown', function (e) {
      if (e.key === 'Escape') {
        closeModal();
        document.getElementById('menuDropdown').classList.remove('show');
        document.getElementById('profileDropdown').classList.remove('show');
      }
    });
  </script>

</body>

</html>