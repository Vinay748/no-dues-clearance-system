<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <title>EFile Transfer Form</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">

  <style>
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: #f8f9fa;
      color: #2c3e50;
      line-height: 1.6;
      padding: 20px;
      font-weight: 400;
    }

    /* Main Container */
    .container {
      max-width: 1000px;
      margin: 0 auto;
      background: #fff;
      border: 1px solid #e9ecef;
      border-radius: 8px;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
      overflow: hidden;
    }

    /* Header */
    .form-header {
      background: #2c5aa0;
      color: white;
      padding: 25px;
      text-align: center;
    }

    .form-header h1 {
      font-size: 1.5rem;
      font-weight: 600;
      margin-bottom: 10px;
      letter-spacing: -0.025em;
    }

    .form-subtitle {
      font-size: 0.9rem;
      opacity: 0.9;
      font-weight: 400;
    }

    /* Form Content */
    .form-content {
      padding: 30px;
    }

    /* Note Section */
    .note-section {
      background: #f8f9fa;
      border: 1px solid #e9ecef;
      border-radius: 6px;
      padding: 15px;
      margin-bottom: 25px;
      text-align: center;
    }

    .note-text {
      font-style: italic;
      color: #6c757d;
      font-size: 0.9rem;
    }

    /* Form Sections */
    .form-section {
      margin-bottom: 30px;
      padding: 25px;
      background: #fff;
      border: 1px solid #e9ecef;
      border-radius: 8px;
    }

    .section-title {
      font-size: 1.1rem;
      font-weight: 600;
      color: #2c3e50;
      margin-bottom: 20px;
      padding-bottom: 10px;
      border-bottom: 2px solid #e9ecef;
    }

    /* Recipient Information */
    .recipient-info {
      background: #f8f9fa;
      padding: 20px;
      border-radius: 6px;
      margin-bottom: 25px;
    }

    .recipient-title {
      font-weight: 600;
      color: #495057;
      margin-bottom: 10px;
    }

    .recipient-details {
      color: #6c757d;
      line-height: 1.5;
    }

    /* Form Fields */
    .field-group {
      margin-bottom: 20px;
    }

    .field-paragraph {
      line-height: 1.8;
      font-size: 0.95rem;
      color: #495057;
      margin-bottom: 20px;
    }

    .field-input {
      border: none;
      border-bottom: 1px solid #ced4da;
      padding: 4px 8px;
      font-family: 'Inter', sans-serif;
      font-size: 0.95rem;
      background: transparent;
      min-width: 120px;
      transition: border-color 0.3s ease;
      margin: 0 3px;
    }

    .field-input:focus {
      outline: none;
      border-bottom-color: #2c5aa0;
      background: #f8f9fa;
    }

    .field-input.wide {
      min-width: 180px;
    }

    .field-input.short {
      min-width: 80px;
    }

    .field-select {
      border: 1px solid #ced4da;
      border-radius: 4px;
      padding: 4px 8px;
      font-family: 'Inter', sans-serif;
      font-size: 0.95rem;
      background: white;
      margin: 0 3px;
    }

    .field-select:focus {
      outline: none;
      border-color: #2c5aa0;
    }

    /* Table Styling */
    .table-section {
      margin: 25px 0;
    }

    .table-header {
      font-weight: 600;
      color: #495057;
      margin-bottom: 15px;
      font-size: 0.95rem;
    }

    .table-container {
      overflow-x: auto;
      border: 1px solid #e9ecef;
      border-radius: 6px;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      background: white;
    }

    th,
    td {
      padding: 12px;
      text-align: center;
      border-bottom: 1px solid #e9ecef;
      font-size: 0.9rem;
    }

    th {
      background: #2c5aa0;
      color: white;
      font-weight: 600;
      font-size: 0.85rem;
      text-transform: uppercase;
      letter-spacing: 0.05em;
    }

    td input {
      border: none;
      background: transparent;
      text-align: center;
      width: 100%;
      padding: 6px;
      font-family: 'Inter', sans-serif;
      font-size: 0.9rem;
    }

    td input:focus {
      outline: none;
      background: #f8f9fa;
    }

    .add-row-btn {
      background: #28a745;
      color: white;
      border: none;
      padding: 8px 16px;
      border-radius: 4px;
      cursor: pointer;
      font-size: 0.85rem;
      font-weight: 500;
      margin-top: 10px;
      transition: all 0.3s ease;
      font-family: 'Inter', sans-serif;
    }

    .add-row-btn:hover {
      background: #218838;
      transform: translateY(-1px);
    }

    /* HOD Section */
    .hod-section {
      background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
      border: 1px solid #dee2e6;
      border-left: 4px solid #2c5aa0;
    }

    .hod-grid {
      display: grid;
      grid-template-columns: 1fr 300px;
      gap: 30px;
      align-items: start;
    }

    .hod-details {
      display: grid;
      gap: 15px;
    }

    .input-group {
      display: flex;
      flex-direction: column;
    }

    .input-group label {
      font-size: 0.85rem;
      font-weight: 600;
      color: #495057;
      margin-bottom: 5px;
      text-transform: uppercase;
      letter-spacing: 0.05em;
    }

    .input-group input {
      padding: 8px 12px;
      border: 1px solid #ced4da;
      border-radius: 4px;
      background: #f8f9fa;
      color: #495057;
      font-size: 0.9rem;
      font-weight: 500;
      font-family: 'Inter', sans-serif;
    }

    .auto-filled {
      background: #d4edda !important;
      border-color: #28a745 !important;
    }

    /* Signature Area */
    .signature-container {
      display: flex;
      flex-direction: column;
      align-items: center;
    }

    .signature-area {
      width: 100%;
      height: 80px;
      border: 2px dashed #ced4da;
      border-radius: 6px;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      margin-bottom: 15px;
      transition: all 0.3s ease;
      background: #fff;
    }

    .signature-area:hover {
      border-color: #2c5aa0;
      background: #f8f9ff;
    }

    .signature-area.has-signature {
      border-color: #28a745;
      background: #f8fff8;
    }

    .signature-placeholder {
      color: #6c757d;
      font-size: 0.9rem;
      text-align: center;
      font-weight: 500;
    }

    .signature-note {
      font-size: 0.8rem;
      color: #6c757d;
      text-align: center;
      font-style: italic;
    }

    /* IT Footer Section */
    .it-footer {
      background: #f8f9fa;
      border: 1px solid #e9ecef;
      border-left: 4px solid #6c757d;
      padding: 20px 25px;
    }

    .it-title {
      font-weight: 600;
      color: #495057;
      margin-bottom: 5px;
    }

    /* Action Buttons */
    .action-section {
      padding: 25px 30px;
      background: #f8f9fa;
      border-top: 1px solid #e9ecef;
      text-align: center;
    }

    .save-button {
      background: #2c5aa0;
      color: white;
      border: none;
      padding: 12px 30px;
      border-radius: 6px;
      cursor: pointer;
      font-size: 0.9rem;
      font-weight: 600;
      font-family: 'Inter', sans-serif;
      transition: all 0.3s ease;
      text-transform: uppercase;
      letter-spacing: 0.05em;
    }

    .save-button:hover {
      background: #1a4480;
      transform: translateY(-1px);
    }

    .save-button:disabled {
      background: #6c757d;
      cursor: not-allowed;
      opacity: 0.6;
      transform: none;
    }

    /* Messages */
    .save-message {
      margin-top: 15px;
      padding: 12px 20px;
      border-radius: 6px;
      font-weight: 500;
      text-align: center;
      display: none;
      font-family: 'Inter', sans-serif;
    }

    .save-message.success {
      background: #d4edda;
      color: #155724;
      border: 1px solid #c3e6cb;
    }

    .save-message.error {
      background: #f8d7da;
      color: #721c24;
      border: 1px solid #f5c6cb;
    }

    .save-message.info {
      background: #cce5ff;
      color: #004085;
      border: 1px solid #b3d7ff;
    }

    .readonly-section {
      opacity: 0.7;
      pointer-events: none;
    }

    /* Mobile Responsive */
    @media (max-width: 768px) {
      body {
        padding: 15px;
      }

      .form-content {
        padding: 20px;
      }

      .hod-grid {
        grid-template-columns: 1fr;
        gap: 20px;
      }

      .field-paragraph {
        line-height: 2;
      }

      .field-input {
        display: block;
        width: 100%;
        margin: 5px 0;
        min-width: auto;
      }

      .field-select {
        display: block;
        width: 100%;
        margin: 5px 0;
      }

      .table-container {
        font-size: 0.8rem;
      }

      th,
      td {
        padding: 8px 4px;
      }

      .action-section {
        padding: 20px;
      }
    }

    .hidden {
      display: none;
    }

    /* Form Status Banner Styles */
    .form-status-banner {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 12px 16px;
      border-radius: 6px;
      margin-bottom: 16px;
      font-size: 14px;
      font-weight: 500;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
      transition: all 0.3s ease;
    }

    .form-status-banner.status-info {
      background: #d1ecf1;
      color: #0c5460;
      border: 1px solid #bee5eb;
    }

    .form-status-banner.status-warning {
      background: #fff3cd;
      color: #856404;
      border: 1px solid #ffeaa7;
    }

    .form-status-banner.status-success {
      background: #d4edda;
      color: #155724;
      border: 1px solid #c3e6cb;
    }

    .form-status-banner.status-error {
      background: #f8d7da;
      color: #721c24;
      border: 1px solid #f5c6cb;
    }

    .status-content {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .status-icon {
      font-size: 18px;
    }

    .status-text strong {
      display: block;
      margin-bottom: 4px;
    }

    .close-btn {
      background: none;
      border: none;
      font-size: 18px;
      cursor: pointer;
      opacity: 0.7;
      padding: 4px;
      width: 24px;
      height: 24px;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 50%;
      transition: all 0.2s ease;
    }

    .close-btn:hover {
      opacity: 1;
      background: rgba(0, 0, 0, 0.1);
    }

    /* Read-only form styling */
    .read-only {
      background-color: #f8f9fa !important;
      color: #6c757d !important;
      border-color: #dee2e6 !important;
      cursor: not-allowed !important;
    }

    .form-container.read-only {
      position: relative;
    }

    .form-container.read-only::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(248, 249, 250, 0.3);
      pointer-events: none;
      z-index: 1;
      border-radius: inherit;
    }
  </style>
  <script src="/js/formStatusManager.js"></script>

  <!-- Enhanced Navigation System -->
  <link rel="stylesheet" href="../css/navigationStyles.css">
  <script src="../js/navigationManager.js"></script>
  <script src="../js/formNavigationIntegration.js"></script>
</head>

<body>
  <div class="container">
    <!-- Professional Header -->
    <div class="form-header">
      <h1>Transfer of E-Files in EOffice</h1>
      <div class="form-subtitle">Official Format for E-File Transfer Request</div>
    </div>

    <!-- Form Content -->
    <div class="form-content">

      <!-- Note Section -->
      <div class="note-section">
        <div class="note-text">To be sent to local IT Head by concerned HOD</div>
      </div>

      <!-- Recipient Information -->
      <div class="form-section" data-role="employee">
        <div class="section-title">Recipient Information</div>

        <div class="recipient-info">
          <div class="recipient-title">To</div>
          <div class="recipient-details">
            Head of Department<br>
            IT Department<br>
            <input type="text" class="field-input wide" id="customField" name="customField">
          </div>
        </div>
      </div>

      <!-- Transfer Request Details -->
      <div class="form-section" data-role="employee">
        <div class="section-title">Transfer Request Details</div>

        <div class="field-group">
          <div class="field-paragraph">
            Due to the
            <select id="reason" name="reason" class="field-select">
              <option value="">Select Reason</option>
              <option>Transfer</option>
              <option>Superannuation</option>
              <option>Resignation (Leaving the Company)</option>
              <option>Death</option>
              <option>Dry-Lien</option>
              <option>Deputation</option>
            </select>
            of
            <select id="salutation" name="salutation" class="field-select">
              <option value="">Salutation</option>
              <option>Mr.</option>
              <option>Ms.</option>
              <option>Mrs.</option>
            </select>
            <input type="text" class="field-input" id="empName" name="empName">
          </div>

          <div class="field-paragraph">
            Designation
            <input type="text" class="field-input" id="designation" name="designation">
            Employee No.
            <input type="text" class="field-input short" id="empNo" name="empNo">
          </div>

          <div class="field-paragraph">
            please transfer the E-Files in his/her EOffice Id
            <input type="text" class="field-input wide" id="fromEoffice" name="fromEoffice">
            to EOffice Id
            <input type="text" class="field-input wide" id="toEoffice" name="toEoffice">
          </div>

          <div class="field-paragraph">
            of
            <select id="tosalutation" name="tosalutation" class="field-select">
              <option value="">Salutation</option>
              <option>Mr.</option>
              <option>Ms.</option>
              <option>Mrs.</option>
            </select>
            <input type="text" class="field-input" id="toName" name="toName">
            Designation
            <input type="text" class="field-input" id="toDesignation" name="toDesignation">
            Employee No.
            <input type="text" class="field-input short" id="toEmpNo" name="toEmpNo">
          </div>
        </div>
      </div>

      <!-- Multiple Transfer Table -->
      <div class="form-section" data-role="employee">
        <div class="section-title">Multiple Transfer Details</div>

        <div class="table-header">
          OR as per following details (if E-Files are required to be transferred to more than one person)
        </div>

        <div class="table-container">
          <table id="efileTable">
            <thead>
              <tr>
                <th>Sl. No.</th>
                <th>Transfer from EOffice Id</th>
                <th>Transfer to EOffice Id</th>
                <th>Electronic File No.</th>
              </tr>
            </thead>
            <tbody id="efileBody">
              <tr>
                <td><input type="number" name="sl1" value="1"></td>
                <td><input type="text" name="from1"></td>
                <td><input type="text" name="to1"></td>
                <td><input type="text" name="file1"></td>
              </tr>
            </tbody>
          </table>
        </div>

        <button type="button" class="add-row-btn" onclick="addRow()">+ Add Row</button>
      </div>

      <!-- HOD Approval Section -->
      <div class="form-section hod-section" data-role="hod">
        <div class="section-title">HOD Approval Section</div>

        <div class="hod-grid">
          <div class="hod-details">
            <div class="input-group">
              <label>Name of HOD</label>
              <input type="text" name="hodName" id="hodName" readonly>
            </div>
            <div class="input-group">
              <label>Employee No.</label>
              <input type="text" name="hodEmpNo" id="hodEmpNo" readonly>
            </div>
            <div class="input-group">
              <label>Email</label>
              <input type="email" name="hodEmail" id="hodEmail" readonly>
            </div>
          </div>

          <div class="signature-container">
            <div class="signature-area" id="hodSignatureArea">
              <div class="signature-placeholder">Click to Upload HOD Signature</div>
            </div>
            <div class="signature-note">HOD details are auto-filled from your session</div>
            <input type="file" id="hodSignatureInput" style="display:none;" accept="image/*">
          </div>
        </div>
      </div>

      <!-- IT Department Section -->
      <div class="form-section it-footer">
        <div class="section-title">For Office Use in IT Department</div>
        <div class="it-title">DGM (IT) / EOffice Administrator</div>
      </div>

    </div>

    <!-- Action Section -->
    <div class="action-section">
      <button class="save-button" onclick="saveEFileForm()">Save EFile Form</button>
      <div id="saveMessage" class="save-message"></div>
    </div>
  </div>

  <script>
    // Global variables
    let currentUserRole = '';
    let formId = '';
    let rowCount = 1;

    // Initialize form
    window.addEventListener("DOMContentLoaded", async () => {
      await initializeForm();
    });

    // Check if this is HOD review mode
    function isHODReview() {
      const urlParams = new URLSearchParams(window.location.search);
      return urlParams.get('role') === 'hod';
    }

    // Auto-fill HOD details when accessed by HOD
    async function autoFillHODDetailsInForm() {
      if (!isHODReview()) return;

      try {
        showMessage('Loading HOD details for form review...', 'info');

        const response = await fetch('/api/hod/my-details', {
          credentials: 'include'
        });

        if (response.ok) {
          const data = await response.json();
          if (data.success && data.hodDetails) {

            const hodDetails = data.hodDetails;

            // Map HOD details to form fields
            const hodFieldMappings = {
              'hodName': hodDetails.name,
              'hodEmpNo': hodDetails.employeeId,
              'hodEmail': hodDetails.email
            };

            // Fill all matching fields
            Object.entries(hodFieldMappings).forEach(([fieldId, value]) => {
              const field = document.getElementById(fieldId);
              if (field && !field.value) {
                field.value = value;

                // Style as auto-filled - GREEN
                field.classList.add('auto-filled');
                field.style.backgroundColor = '#d4edda';
                field.style.borderColor = '#28a745';
                field.style.color = '#155724';
                field.title = 'Auto-filled from HOD session';

                field.readOnly = true;

              }
            });

            // Auto-load HOD signature
            await autoFillHODSignatureInForm();

            showMessage('HOD details auto-filled successfully!', 'success');

            // Update signature note
            const signatureNote = document.querySelector('.signature-note');
            if (signatureNote) {
              signatureNote.textContent = `HOD details auto-filled for ${hodDetails.name}`;
            }
          }
        }
      } catch (error) {
        showMessage('Failed to auto-fill HOD details', 'error');
      }
    }

    // Auto-fill HOD signature in form
    async function autoFillHODSignatureInForm() {
      try {
        const response = await fetch('/api/hod/get-signature', {
          credentials: 'include'
        });

        if (response.ok) {
          const data = await response.json();
          if (data.success && data.signatureUrl) {
            const sigArea = document.getElementById('hodSignatureArea');
            if (sigArea) {
              sigArea.innerHTML = `<img src="${data.signatureUrl}" alt="HOD Signature" style="max-height: 60px; max-width: 100%; border: 2px solid #2196f3; border-radius: 4px;">`;
              sigArea.classList.add('has-signature');
              sigArea.title = 'HOD signature auto-loaded';
            }
          }
        }
      } catch (error) {
      }
    }

    // Initialize form with role detection and HOD auto-fill
    async function initializeForm() {
      try {
        // Get form ID from URL
        const urlParams = new URLSearchParams(window.location.search);
        formId = urlParams.get("formId") || "";

        // Get user role from session
        await getUserRole();

        // Auto-fill HOD details if in HOD review mode
        if (isHODReview()) {
          setTimeout(autoFillHODDetailsInForm, 1000);
        }

        // Load HOD profile if user is HOD (existing functionality)
        if (currentUserRole === 'hod') {
          await loadHODProfile();
          await loadHODSignature();
        }

        // Load existing form data
        await loadFormData();

        // Set up role-based permissions
        setupRoleBasedAccess();

        // Initialize signature handling
        initializeSignatureHandling();

      } catch (error) {
        showMessage('Error loading form. Please refresh the page.', 'error');
      }
    }

    // Get user role from session
    async function getUserRole() {
      try {
        const response = await fetch('/api/auth/check-session', {
          credentials: 'include'
        });

        if (response.ok) {
          const data = await response.json();
          currentUserRole = data.role || '';
        }
      } catch (error) {
        currentUserRole = 'employee'; // Default fallback
      }
    }

    // Load HOD profile and auto-fill fields
    async function loadHODProfile() {
      try {

        const response = await fetch('/api/hod/profile', {
          credentials: 'include'
        });

        if (response.ok) {
          const data = await response.json();
          if (data.success) {
            // Auto-fill HOD fields
            const hodName = document.getElementById('hodName');
            const hodEmpNo = document.getElementById('hodEmpNo');
            const hodEmail = document.getElementById('hodEmail');

            if (hodName) {
              hodName.value = data.hodData.name;
              hodName.classList.add('auto-filled');
            }
            if (hodEmpNo) {
              hodEmpNo.value = data.hodData.employeeId;
              hodEmpNo.classList.add('auto-filled');
            }
            if (hodEmail) {
              hodEmail.value = data.hodData.email;
              hodEmail.classList.add('auto-filled');
            }

          }
        }
      } catch (error) {
      }
    }

    // Load existing HOD signature
    async function loadHODSignature() {
      try {
        const response = await fetch('/api/hod/get-signature', {
          credentials: 'include'
        });

        if (response.ok) {
          const data = await response.json();
          if (data.success && data.signatureUrl) {
            const sigArea = document.getElementById('hodSignatureArea');
            if (sigArea) {
              sigArea.innerHTML = `<img src="${data.signatureUrl}" alt="HOD Signature" style="max-height: 60px; max-width: 100%;">`;
              sigArea.classList.add('has-signature');
            }
          }
        }
      } catch (error) {
      }
    }

    // Initialize signature upload handling
    function initializeSignatureHandling() {
      const hodSignatureArea = document.getElementById('hodSignatureArea');
      const hodSignatureInput = document.getElementById('hodSignatureInput');

      if (hodSignatureArea && hodSignatureInput) {
        hodSignatureArea.addEventListener('click', () => {
          if (currentUserRole === 'hod') {
            hodSignatureInput.click();
          }
        });

        hodSignatureInput.addEventListener('change', handleSignatureUpload);
      }
    }

    // Handle signature file upload
    async function handleSignatureUpload(event) {
      const file = event.target.files[0];
      if (!file) return;

      try {
        // Preview signature
        const reader = new FileReader();
        reader.onload = function (e) {
          const sigArea = document.getElementById('hodSignatureArea');
          if (sigArea) {
            sigArea.innerHTML = `<img src="${e.target.result}" alt="HOD Signature" style="max-height: 60px; max-width: 100%;">`;
            sigArea.classList.add('has-signature');
          }
        };
        reader.readAsDataURL(file);

        // Upload to server
        const formData = new FormData();
        formData.append('signature', file);

        const response = await fetch('/api/hod/upload-signature', {
          method: 'POST',
          body: formData,
          credentials: 'include'
        });

        if (response.ok) {
          showMessage('Signature uploaded successfully', 'success');
        } else {
          throw new Error('Failed to upload signature');
        }

      } catch (error) {
        showMessage('Failed to upload signature', 'error');
      }
    }

    // Set up role-based access control
    function setupRoleBasedAccess() {
      document.querySelectorAll('[data-role]').forEach(section => {
        const roleType = section.getAttribute('data-role');
        const shouldBeEditable = (
          (roleType === 'employee' && currentUserRole === 'employee') ||
          (roleType === 'hod' && currentUserRole === 'hod') ||
          (roleType === 'it' && currentUserRole === 'it')
        );

        if (!shouldBeEditable) {
          section.classList.add('readonly-section');
        }
      });

      // Lock form fields for HOD except HOD-specific fields
      if (currentUserRole === 'hod') {
        document.querySelectorAll('input:not([id^="hod"]), select').forEach(input => {
          input.setAttribute('readonly', true);
          input.style.backgroundColor = '#f8f9fa';
        });
      }
    }

    // Add table row function
    function addRow() {
      if (currentUserRole === 'hod') return; // HOD can't add rows

      rowCount++;
      const tbody = document.getElementById("efileBody");
      const row = document.createElement("tr");
      row.innerHTML = `
        <td><input type="number" name="sl${rowCount}" value="${rowCount}"></td>
        <td><input type="text" name="from${rowCount}"></td>
        <td><input type="text" name="to${rowCount}"></td>
        <td><input type="text" name="file${rowCount}"></td>
      `;
      tbody.appendChild(row);
    }

    // Enhanced save function with HOD data
    async function saveEFileForm() {
      try {
        showMessage('Saving form...', 'info');

        const formData = collectFormData();

        // Save to server
        const response = await fetch('/api/employee/save-efile', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          credentials: 'include',
          body: JSON.stringify({ efileForm: formData })
        });

        const result = await response.json();

        if (response.ok && result.success) {
          // Save to localStorage for dashboard access
          localStorage.setItem('efileFormData', JSON.stringify(formData));

          showMessage(result.message || 'Form saved successfully!', 'success');
        } else {
          throw new Error(result.message || 'Failed to save form');
        }

      } catch (error) {
        showMessage('Failed to save form: ' + error.message, 'error');
      }
    }

    // Collect all form data including HOD fields and table data
    function collectFormData() {
      const getValue = (id) => {
        const el = document.getElementById(id);
        if (!el) return "";
        return el.value || "";
      };

      const formData = {
        // Basic form fields
        reason: getValue("reason"),
        customField: getValue("customField"),
        salutation: getValue("salutation"),
        empName: getValue("empName"),
        designation: getValue("designation"),
        empNo: getValue("empNo"),
        fromEoffice: getValue("fromEoffice"),
        toEoffice: getValue("toEoffice"),
        tosalutation: getValue("tosalutation"),
        toName: getValue("toName"),
        toDesignation: getValue("toDesignation"),
        toEmpNo: getValue("toEmpNo"),

        // HOD fields (auto-filled)
        hodName: getValue("hodName"),
        hodEmpNo: getValue("hodEmpNo"),
        hodEmail: getValue("hodEmail"),

        // Table data
        tableRows: [],

        // Metadata
        formId: formId,
        lastUpdated: new Date().toISOString(),
        userRole: currentUserRole
      };

      // Include signature if present
      const sigImg = document.querySelector("#hodSignatureArea img");
      if (sigImg) formData.hodSignature = sigImg.src;

      // Collect table data
      const tableBody = document.getElementById('efileBody');
      if (tableBody) {
        const rows = tableBody.querySelectorAll('tr');
        rows.forEach(tr => {
          const slInput = tr.querySelector('input[name^="sl"]');
          const fromInput = tr.querySelector('input[name^="from"]');
          const toInput = tr.querySelector('input[name^="to"]');
          const fileInput = tr.querySelector('input[name^="file"]');

          formData.tableRows.push({
            sl: slInput ? slInput.value : "",
            from: fromInput ? fromInput.value : "",
            to: toInput ? toInput.value : "",
            file: fileInput ? fileInput.value : ""
          });
        });
      }

      return formData;
    }

    // Load existing form data
    async function loadFormData() {
      try {
        let formData = null;

        if (formId && (currentUserRole === 'hod' || currentUserRole === 'it')) {
          // Load from server for HOD/IT review
          const response = await fetch(`/api/hod/form-details?formId=${encodeURIComponent(formId)}`, {
            credentials: 'include'
          });
          const data = await response.json();
          formData = data?.efileFormData;
        } else {
          // Load from server for employee
          const response = await fetch('/api/employee/form-data?formName=efileForm', {
            credentials: 'include'
          });
          const data = await response.json();
          formData = data?.formData;
        }

        if (formData) {
          // Populate basic form fields
          Object.entries(formData).forEach(([key, value]) => {
            if (key !== 'tableRows' && key !== 'hodSignature') {
              const el = document.getElementById(key);
              if (el) {
                el.value = value || '';
              }
            }
          });

          // Load table rows
          if (formData.tableRows && Array.isArray(formData.tableRows) && formData.tableRows.length > 0) {
            const tbody = document.getElementById("efileBody");
            if (tbody) {
              tbody.innerHTML = "";
              formData.tableRows.forEach((row, index) => {
                const tr = document.createElement("tr");
                tr.innerHTML = `
                  <td><input type="number" name="sl${index + 1}" value="${row.sl || index + 1}" ${currentUserRole === 'hod' ? 'readonly' : ''}></td>
                  <td><input type="text" name="from${index + 1}" value="${row.from || ''}" ${currentUserRole === 'hod' ? 'readonly' : ''}></td>
                  <td><input type="text" name="to${index + 1}" value="${row.to || ''}" ${currentUserRole === 'hod' ? 'readonly' : ''}></td>
                  <td><input type="text" name="file${index + 1}" value="${row.file || ''}" ${currentUserRole === 'hod' ? 'readonly' : ''}></td>
                `;
                tbody.appendChild(tr);
              });
              rowCount = formData.tableRows.length;
            }
          }

          // Show signature if available
          if (formData.hodSignature) {
            const sigArea = document.getElementById('hodSignatureArea');
            if (sigArea) {
              sigArea.innerHTML = `<img src="${formData.hodSignature}" alt="HOD Signature" style="max-height: 60px; max-width: 100%;">`;
              sigArea.classList.add('has-signature');
            }
          }

        }

      } catch (error) {
      }
    }

    // Show status messages
    function showMessage(message, type) {
      const messageEl = document.getElementById('saveMessage');
      if (messageEl) {
        messageEl.textContent = message;
        messageEl.className = `save-message ${type}`;
        messageEl.style.display = 'block';

        // Auto-hide success messages
        if (type === 'success') {
          setTimeout(() => {
            messageEl.style.display = 'none';
          }, 3000);
        }
      }
    }

    // Initialize navigation for specific form type
    document.addEventListener('DOMContentLoaded', () => {
      // Determine form type from URL or page structure
      const formType = window.location.pathname.includes('disposal') ? 'disposal' :
        window.location.pathname.includes('efile') ? 'efile' :
          window.location.pathname.includes('365transfer') ? 'form365transfer' :
            window.location.pathname.includes('365disposal') ? 'form365disposal' : 'unknown';

      // Initialize navigation for this form
      FormNavigationIntegration.initializeForForm(formType);

    });

    // Enhanced role-based element hiding with proper jQuery selectors
    function initializeRoleBasedUI() {

      // Multiple methods to detect user role
      function detectUserRole() {
        // Method 1: From localStorage/sessionStorage
        let role = localStorage.getItem('userRole') || sessionStorage.getItem('userRole');

        // Method 2: From page title or URL
        if (!role) {
          if (window.location.href.includes('hod') || window.location.href.includes('HOD')) {
            role = 'HOD';
          } else if (window.location.href.includes('itreview') || window.location.href.includes('IT')) {
            role = 'IT';
          }
        }

        // Method 3: From a meta tag or hidden input
        const roleElement = document.querySelector('meta[name="user-role"]') ||
          document.querySelector('input[name="userRole"]');
        if (!role && roleElement) {
          role = roleElement.content || roleElement.value;
        }

        // Method 4: From server-rendered data
        if (!role && typeof window.userRole !== 'undefined') {
          role = window.userRole;
        }

        // Method 5: From authentication/session cookies (if available)
        if (!role && document.cookie) {
          const cookieRole = document.cookie
            .split('; ')
            .find(row => row.startsWith('userRole='));
          if (cookieRole) {
            role = cookieRole.split('=')[1];
          }
        }

        return role ? role.toLowerCase() : null;
      }

      const userRole = detectUserRole();

      if (userRole === 'hod' || userRole === 'it') {

        // Hide back buttons with multiple selectors
        const elementsToHide = [
          '.global-back-button',
          '.back-btn',
          'button[onclick*="goBack"]',
          'button[onclick*="history.back"]',
          'button[onclick*="window.history"]',
          'a[href*="dashboard"]',
          'a[href*="back"]',
          '.navigation-back',
          '.back-to-dashboard',
          '[class*="back"]',
          '[id*="back"]'
        ];

        elementsToHide.forEach(selector => {
          try {
            const elements = document.querySelectorAll(selector);
            elements.forEach(el => {
              const elementText = el.textContent.toLowerCase();
              const isBackButton = elementText.includes('back') ||
                elementText.includes('dashboard') ||
                el.onclick?.toString().includes('back') ||
                el.onclick?.toString().includes('goBack');

              if (isBackButton || selector.includes('back') || selector.includes('dashboard')) {
                el.style.display = 'none';
                el.setAttribute('tabindex', '-1');
                el.setAttribute('aria-hidden', 'true');
              }
            });
          } catch (error) {
          }
        });

        // Hide save buttons COMPLETELY using proper selectors
        const saveSelectors = [
          'button[type="submit"]',
          'input[type="submit"]',
          '.save-button',
          '.save-btn',
          'button[onclick*="save"]',
          'button[onclick*="submit"]',
          'button[onclick*="Save"]',
          '#saveBtn',
          '#submitBtn',
          '[value*="Save"]',
          '[value*="Submit"]',
          'input[value*="Save"]',
          '.btn-primary[onclick*="save"]'
        ];

        saveSelectors.forEach(selector => {
          try {
            const elements = document.querySelectorAll(selector);
            elements.forEach(el => {
              const elementText = (el.textContent || el.value || el.innerHTML || '').toLowerCase();
              const isSaveButton = elementText.includes('save') ||
                elementText.includes('submit') ||
                el.type === 'submit' ||
                el.name === 'submit' ||
                el.id?.includes('save') ||
                el.className?.includes('save');

              if (isSaveButton) {
                // HIDE COMPLETELY (not just disable)
                el.style.display = 'none !important';
                el.setAttribute('aria-hidden', 'true');
                el.setAttribute('tabindex', '-1');

                // Also hide parent container if it only contains the save button
                const parent = el.parentElement;
                if (parent && parent.children.length === 1) {
                  parent.style.display = 'none';
                }

                // Remove from form submission
                if (el.form) {
                  el.remove();
                }
              }
            });
          } catch (error) {
          }
        });

        // Hide save buttons by text content using filter
        if (typeof $ !== 'undefined') {
          // Use jQuery filter instead of :contains selector
          $('button').filter(function () {
            return $(this).text().toLowerCase().includes('save');
          }).hide();

          $('button').filter(function () {
            return $(this).text().toLowerCase().includes('submit');
          }).hide();

        } else {
          // Vanilla JavaScript fallback
          const allButtons = document.querySelectorAll('button, input[type="button"], input[type="submit"]');
          allButtons.forEach(button => {
            const text = (button.textContent || button.value || '').toLowerCase();
            if (text.includes('save') || text.includes('submit') || text.includes('update')) {
              button.style.display = 'none !important';
              button.setAttribute('aria-hidden', 'true');

              // Hide parent if it's a button container
              const parent = button.parentElement;
              if (parent && (parent.className.includes('button') || parent.className.includes('action'))) {
                parent.style.display = 'none';
              }
            }
          });
        }

        // Add role-based CSS class
        document.body.classList.add(`role-${userRole}`);
        document.body.setAttribute('data-user-role', userRole);

      } else {
      }
    }

    // Run multiple times to catch all elements
    document.addEventListener('DOMContentLoaded', initializeRoleBasedUI);
    window.addEventListener('load', initializeRoleBasedUI);

    // Check again after navigation manager loads
    setTimeout(initializeRoleBasedUI, 500);
    setTimeout(initializeRoleBasedUI, 2000);
    setTimeout(initializeRoleBasedUI, 4000);

    // Set up observer for dynamically added elements
    if (typeof MutationObserver !== 'undefined') {
      const observer = new MutationObserver(function (mutations) {
        let shouldReapply = false;

        mutations.forEach(function (mutation) {
          if (mutation.addedNodes.length > 0) {
            mutation.addedNodes.forEach(function (node) {
              if (node.nodeType === Node.ELEMENT_NODE) {
                const hasSaveButton = node.querySelector && (
                  node.querySelector('button[type="submit"]') ||
                  node.querySelector('.save-button') ||
                  node.querySelector('input[type="submit"]') ||
                  (node.textContent && node.textContent.toLowerCase().includes('save'))
                );

                if (hasSaveButton) {
                  shouldReapply = true;
                }
              }
            });
          }
        });

        if (shouldReapply) {
          setTimeout(initializeRoleBasedUI, 100);
        }
      });

      observer.observe(document.body, {
        childList: true,
        subtree: true
      });
    }

    // Message listener for iframe data population
    window.addEventListener('message', function (event) {

      if (event.data && event.data.action === 'populateForm') {
        const data = event.data.data;

        // Loop through all data fields and populate matching elements
        Object.keys(data).forEach(fieldId => {
          const element = document.getElementById(fieldId);
          if (element) {
            if (element.tagName === 'INPUT' || element.tagName === 'TEXTAREA' || element.tagName === 'SELECT') {
              element.value = data[fieldId] || '';
            } else if (element.tagName === 'IMG') {
              element.src = data[fieldId] || '';
            } else {
              element.textContent = data[fieldId] || '';
            }
          }
        });

        // If read-only mode, disable all inputs
        if (event.data.isReadOnly) {
          document.querySelectorAll('input, select, textarea, button').forEach(el => {
            el.disabled = true;
            el.style.backgroundColor = '#f8f9fa';
            el.style.cursor = 'not-allowed';
          });
        }
      }

      if (event.data && event.data.action === 'setMode') {
        if (event.data.isReadOnly) {
          document.querySelectorAll('input, select, textarea, button').forEach(el => {
            el.disabled = true;
            el.style.backgroundColor = '#f8f9fa';
          });
        }
      }
    });

    // Also check URL parameters for data (fallback method)
    window.addEventListener('DOMContentLoaded', function () {
      const urlParams = new URLSearchParams(window.location.search);
      const mode = urlParams.get('mode');
      const existingData = urlParams.get('existingData');

      if (existingData) {
        try {
          const data = JSON.parse(decodeURIComponent(existingData));

          Object.keys(data).forEach(fieldId => {
            const element = document.getElementById(fieldId);
            if (element && element.value !== undefined) {
              element.value = data[fieldId] || '';
            }
          });
        } catch (error) {
        }
      }

      if (mode === 'approved' || mode === 'rejected') {
        document.querySelectorAll('input, select, textarea, button').forEach(el => {
          el.disabled = true;
          el.style.backgroundColor = '#f8f9fa';
        });
      }
    });
  </script>

  <script>
    document.addEventListener('DOMContentLoaded', () => {
      FormNavigationIntegration.initializeForForm('efile');
    });
  </script>

</body>

</html>