<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <title>Microsoft 365 Disposal Confirmation</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">

  <style>
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: #f8f9fa;
      color: #2c3e50;
      line-height: 1.6;
      padding: 20px;
      font-weight: 400;
    }

    /* Main Container */
    .container {
      max-width: 1000px;
      margin: 0 auto;
      background: #fff;
      border: 1px solid #e9ecef;
      border-radius: 8px;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
      overflow: hidden;
    }

    /* Header */
    .form-header {
      background: #2c5aa0;
      color: white;
      padding: 25px;
      text-align: center;
    }

    .form-header h1 {
      font-size: 1.5rem;
      font-weight: 600;
      margin-bottom: 10px;
      letter-spacing: -0.025em;
    }

    .form-subtitle {
      font-size: 0.9rem;
      opacity: 0.9;
      font-weight: 400;
    }

    /* Form Content */
    .form-content {
      padding: 30px;
    }

    /* Note Section */
    .note-section {
      background: #f8f9fa;
      border: 1px solid #e9ecef;
      border-radius: 6px;
      padding: 20px;
      margin-bottom: 30px;
    }

    .note-text {
      font-style: italic;
      color: #6c757d;
      font-size: 0.9rem;
      line-height: 1.6;
    }

    .note-select {
      font-weight: 600;
      color: #495057;
      border: 1px solid #ced4da;
      border-radius: 4px;
      padding: 4px 8px;
      background: white;
      margin: 0 3px;
    }

    /* Form Sections */
    .form-section {
      margin-bottom: 30px;
      padding: 25px;
      background: #fff;
      border: 1px solid #e9ecef;
      border-radius: 8px;
    }

    .section-title {
      font-size: 1.1rem;
      font-weight: 600;
      color: #2c3e50;
      margin-bottom: 20px;
      padding-bottom: 10px;
      border-bottom: 2px solid #e9ecef;
    }

    /* Form Fields */
    .field-group {
      margin-bottom: 20px;
    }

    .field-label {
      display: block;
      font-size: 0.85rem;
      font-weight: 600;
      color: #495057;
      margin-bottom: 5px;
      text-transform: uppercase;
      letter-spacing: 0.05em;
    }

    .field-input {
      width: 100%;
      padding: 8px 12px;
      border: 1px solid #ced4da;
      border-radius: 4px;
      background: #fff;
      color: #495057;
      font-size: 0.9rem;
      font-weight: 500;
      font-family: 'Inter', sans-serif;
      transition: border-color 0.3s ease;
    }

    .field-input:focus {
      outline: none;
      border-color: #2c5aa0;
      box-shadow: 0 0 0 2px rgba(44, 90, 160, 0.1);
    }

    .auto-filled {
      background: #d4edda !important;
      border-color: #28a745 !important;
    }

    /* Paragraph Inline Fields */
    .field-paragraph {
      line-height: 1.8;
      font-size: 0.95rem;
      color: #495057;
      margin-bottom: 20px;
    }

    .inline-input {
      border: none;
      border-bottom: 1px solid #ced4da;
      padding: 4px 8px;
      font-family: 'Inter', sans-serif;
      font-size: 0.95rem;
      background: transparent;
      min-width: 120px;
      transition: border-color 0.3s ease;
      margin: 0 3px;
    }

    .inline-input:focus {
      outline: none;
      border-bottom-color: #2c5aa0;
      background: #f8f9fa;
    }

    .inline-input.wide {
      min-width: 180px;
    }

    .inline-input.short {
      min-width: 80px;
    }

    .inline-select {
      border: 1px solid #ced4da;
      border-radius: 4px;
      padding: 4px 8px;
      font-family: 'Inter', sans-serif;
      font-size: 0.95rem;
      background: white;
      margin: 0 3px;
    }

    .inline-select:focus {
      outline: none;
      border-color: #2c5aa0;
    }

    /* HOD Section */
    .hod-section {
      background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
      border: 1px solid #dee2e6;
      border-left: 4px solid #2c5aa0;
    }

    .hod-grid {
      display: grid;
      grid-template-columns: 1fr 300px;
      gap: 30px;
      align-items: start;
    }

    .hod-details {
      display: grid;
      gap: 15px;
    }

    .input-group {
      display: flex;
      flex-direction: column;
    }

    .input-group label {
      font-size: 0.85rem;
      font-weight: 600;
      color: #495057;
      margin-bottom: 5px;
      text-transform: uppercase;
      letter-spacing: 0.05em;
    }

    .input-group input {
      padding: 8px 12px;
      border: 1px solid #ced4da;
      border-radius: 4px;
      background: #f8f9fa;
      color: #495057;
      font-size: 0.9rem;
      font-weight: 500;
      font-family: 'Inter', sans-serif;
    }

    /* Signature Area */
    .signature-container {
      display: flex;
      flex-direction: column;
      align-items: center;
    }

    .signature-area {
      width: 100%;
      height: 80px;
      border: 2px dashed #ced4da;
      border-radius: 6px;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      margin-bottom: 15px;
      transition: all 0.3s ease;
      background: #fff;
    }

    .signature-area:hover {
      border-color: #2c5aa0;
      background: #f8f9ff;
    }

    .signature-area.has-signature {
      border-color: #28a745;
      background: #f8fff8;
    }

    .signature-placeholder {
      color: #6c757d;
      font-size: 0.9rem;
      text-align: center;
      font-weight: 500;
    }

    .signature-note {
      font-size: 0.8rem;
      color: #6c757d;
      text-align: center;
      font-style: italic;
    }

    /* Footer Section */
    .footer-section {
      background: #f8f9fa;
      padding: 20px 25px;
      border-top: 1px solid #e9ecef;
      text-align: center;
    }

    .footer-title {
      font-weight: 600;
      color: #495057;
      margin-bottom: 5px;
      text-decoration: underline;
    }

    /* Action Buttons */
    .action-section {
      padding: 25px 30px;
      background: #f8f9fa;
      border-top: 1px solid #e9ecef;
      text-align: center;
    }

    .save-button {
      background: #2c5aa0;
      color: white;
      border: none;
      padding: 12px 30px;
      border-radius: 6px;
      cursor: pointer;
      font-size: 0.9rem;
      font-weight: 600;
      font-family: 'Inter', sans-serif;
      transition: all 0.3s ease;
      text-transform: uppercase;
      letter-spacing: 0.05em;
    }

    .save-button:hover {
      background: #1a4480;
      transform: translateY(-1px);
    }

    .save-button:disabled {
      background: #6c757d;
      cursor: not-allowed;
      opacity: 0.6;
      transform: none;
    }

    /* Messages */
    .save-message {
      margin-top: 15px;
      padding: 12px 20px;
      border-radius: 6px;
      font-weight: 500;
      text-align: center;
      display: none;
      font-family: 'Inter', sans-serif;
    }

    .save-message.success {
      background: #d4edda;
      color: #155724;
      border: 1px solid #c3e6cb;
    }

    .save-message.error {
      background: #f8d7da;
      color: #721c24;
      border: 1px solid #f5c6cb;
    }

    .save-message.info {
      background: #cce5ff;
      color: #004085;
      border: 1px solid #b3d7ff;
    }

    .readonly-section {
      opacity: 0.7;
      pointer-events: none;
    }

    /* Mobile Responsive */
    @media (max-width: 768px) {
      body {
        padding: 15px;
      }

      .form-content {
        padding: 20px;
      }

      .hod-grid {
        grid-template-columns: 1fr;
        gap: 20px;
      }

      .field-paragraph {
        line-height: 2;
      }

      .inline-input {
        display: block;
        width: 100%;
        margin: 5px 0;
        min-width: auto;
      }

      .inline-select {
        display: block;
        width: 100%;
        margin: 5px 0;
      }

      .action-section {
        padding: 20px;
      }
    }

    .hidden {
      display: none;
    }

    /* Form Status Banner Styles */
    .form-status-banner {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 12px 16px;
      border-radius: 6px;
      margin-bottom: 16px;
      font-size: 14px;
      font-weight: 500;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
      transition: all 0.3s ease;
    }

    .form-status-banner.status-info {
      background: #d1ecf1;
      color: #0c5460;
      border: 1px solid #bee5eb;
    }

    .form-status-banner.status-warning {
      background: #fff3cd;
      color: #856404;
      border: 1px solid #ffeaa7;
    }

    .form-status-banner.status-success {
      background: #d4edda;
      color: #155724;
      border: 1px solid #c3e6cb;
    }

    .form-status-banner.status-error {
      background: #f8d7da;
      color: #721c24;
      border: 1px solid #f5c6cb;
    }

    .status-content {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .status-icon {
      font-size: 18px;
    }

    .status-text strong {
      display: block;
      margin-bottom: 4px;
    }

    .close-btn {
      background: none;
      border: none;
      font-size: 18px;
      cursor: pointer;
      opacity: 0.7;
      padding: 4px;
      width: 24px;
      height: 24px;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 50%;
      transition: all 0.2s ease;
    }

    .close-btn:hover {
      opacity: 1;
      background: rgba(0, 0, 0, 0.1);
    }

    /* Read-only form styling */
    .read-only {
      background-color: #f8f9fa !important;
      color: #6c757d !important;
      border-color: #dee2e6 !important;
      cursor: not-allowed !important;
    }

    .form-container.read-only {
      position: relative;
    }

    .form-container.read-only::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(248, 249, 250, 0.3);
      pointer-events: none;
      z-index: 1;
      border-radius: inherit;
    }
  </style>
  <script src="/js/formStatusManager.js"></script>

  <!-- Enhanced Navigation System -->
  <link rel="stylesheet" href="../css/navigationStyles.css">
  <script src="../js/navigationManager.js"></script>
  <script src="../js/formNavigationIntegration.js"></script>

</head>

<body>
  <div class="container">
    <!-- Professional Header -->
    <div class="form-header">
      <h1>Microsoft 365 Account Disposal</h1>
      <div class="form-subtitle">Official Format for Microsoft 365 Account Disposal Confirmation</div>
    </div>

    <!-- Form Content -->
    <div class="form-content">

      <!-- Note Section -->
      <div class="note-section">
        <div class="note-text">
          Confirmation of following format shall be issued by the concerned HOD on
          <select name="reason" id="reason" class="note-select" required>
            <option value="">Select Reason</option>
            <option value="Superannuation">Superannuation</option>
            <option value="Resignation">Resignation</option>
            <option value="Dry-Lien">Dry-Lien</option>
            <option value="Deputation">Deputation</option>
            <option value="Death">Death</option>
          </select>
          of an Employee under his/her Control. In case of Death of employee, help of Corporate IT may be taken for
          transfer of data from Microsoft 365 cloud account.
        </div>
      </div>

      <!-- Basic Information -->
      <div class="form-section" data-role="employee">
        <div class="section-title">Department Information</div>

        <div class="field-group">
          <label class="field-label">Unit Name</label>
          <input type="text" name="unitName" id="unitName" class="field-input">
        </div>

        <div class="field-group">
          <label class="field-label">Department</label>
          <input type="text" name="department" id="department" class="field-input">
        </div>
      </div>

      <!-- Transfer Confirmation Details -->
      <div class="form-section" data-role="employee">
        <div class="section-title">Data Transfer Confirmation</div>

        <div class="field-group">
          <div class="field-paragraph">
            This is to confirm that all relevant official data (files and folders) from Microsoft 365 cloud account ID
            <input type="text" name="fromId" id="fromId" class="inline-input wide">
            of
            <select name="empSalutation" id="empSalutation" class="inline-select">
              <option value="">Salutation</option>
              <option value="Mr.">Mr.</option>
              <option value="Ms.">Ms.</option>
              <option value="Mrs.">Mrs.</option>
            </select>
            <input type="text" name="empName" id="empName" class="inline-input">
          </div>

          <div class="field-paragraph">
            Designation
            <input type="text" name="designation" id="designation" class="inline-input">
            Employee No.
            <input type="text" name="empNo" id="empNo" class="inline-input short">
          </div>

          <div class="field-paragraph">
            has been downloaded in local system / transferred from his/her Microsoft 365 account ID
            <input type="text" name="oldId" id="oldId" class="inline-input wide">
            to account ID
            <input type="text" name="newId" id="newId" class="inline-input wide">
          </div>

          <div class="field-paragraph">
            of
            <select name="toSalutation" id="toSalutation" class="inline-select">
              <option value="">Salutation</option>
              <option value="Mr.">Mr.</option>
              <option value="Ms.">Ms.</option>
              <option value="Mrs.">Mrs.</option>
            </select>
            <input type="text" name="toEmp" id="toEmp" class="inline-input">
          </div>
        </div>

        <div class="field-group">
          <label class="field-label">Recipient Designation</label>
          <input type="text" name="toDesignation" id="toDesignation" class="field-input">
        </div>

        <div class="field-group">
          <label class="field-label">Recipient Employee No.</label>
          <input type="text" name="toEmpNo" id="toEmpNo" class="field-input">
        </div>

        <div class="field-group">
          <label class="field-label">Date</label>
          <input type="date" name="date" id="date" class="field-input">
        </div>

        <div class="field-group">
          <label class="field-label">Microsoft 365 Account ID to be disposed</label>
          <input type="text" name="disposedId" id="disposedId" class="field-input">
        </div>
      </div>

      <!-- HOD Approval Section -->
      <div class="form-section hod-section" data-role="hod">
        <div class="section-title">HOD Approval Section</div>

        <div class="hod-grid">
          <div class="hod-details">
            <div class="input-group">
              <label>Name of HOD</label>
              <input type="text" name="hodName" id="hodName" readonly>
            </div>
            <div class="input-group">
              <label>Employee No.</label>
              <input type="text" name="hodEmpNo" id="hodEmpNo" readonly>
            </div>
            <div class="input-group">
              <label>Email</label>
              <input type="email" name="hodEmail" id="hodEmail" readonly>
            </div>
          </div>

          <div class="signature-container">
            <div class="signature-area" id="signatureArea">
              <div class="signature-placeholder">Click to Upload HOD Signature</div>
            </div>
            <div class="signature-note">HOD details are auto-filled from your session</div>
            <input type="file" id="signatureInput" style="display:none;" accept="image/*">
          </div>
        </div>
      </div>

    </div>

    <!-- Footer Section -->
    <div class="footer-section">
      <div class="footer-title">HOD, IT Department</div>
      <div class="footer-title">HOD, IT Department, Rishikesh</div>
    </div>

    <!-- Action Section -->
    <div class="action-section">
      <button class="save-button" onclick="saveForm365Disposal()">Save Form 365 Disposal</button>
      <div id="saveMessage" class="save-message"></div>
    </div>
  </div>

  <script>
    // Global variables
    let currentUserRole = '';
    let formId = '';

    // Initialize form
    window.addEventListener("DOMContentLoaded", async () => {
      await initializeForm();
    });

    // Check if this is HOD review mode
    function isHODReview() {
      const urlParams = new URLSearchParams(window.location.search);
      return urlParams.get('role') === 'hod';
    }

    // Auto-fill HOD details when accessed by HOD
    async function autoFillHODDetailsInForm() {
      if (!isHODReview()) return;

      try {
        showMessage('Loading HOD details for form review...', 'info');

        const response = await fetch('/api/hod/my-details', {
          credentials: 'include'
        });

        if (response.ok) {
          const data = await response.json();
          if (data.success && data.hodDetails) {

            const hodDetails = data.hodDetails;

            // Map HOD details to form fields using green theme
            const hodFieldMappings = {
              'hodName': hodDetails.name,
              'hodEmpNo': hodDetails.employeeId,
              'hodEmail': hodDetails.email
            };

            // Fill all matching fields
            Object.entries(hodFieldMappings).forEach(([fieldId, value]) => {
              const field = document.getElementById(fieldId) || document.querySelector(`[name="${fieldId}"]`);
              if (field && !field.value) {
                field.value = value;

                // Style as auto-filled with GREEN theme
                field.classList.add('auto-filled');
                field.style.backgroundColor = '#d4edda';
                field.style.borderColor = '#28a745';
                field.style.color = '#155724';
                field.title = 'Auto-filled from HOD session';
                field.readOnly = true;

              }
            });

            // Auto-load HOD signature
            await autoFillHODSignatureInForm();

            showMessage('HOD details auto-filled successfully!', 'success');

            // Update signature note
            const signatureNote = document.querySelector('.signature-note');
            if (signatureNote) {
              signatureNote.textContent = `HOD details auto-filled for ${hodDetails.name}`;
            }
          }
        }
      } catch (error) {
        showMessage('Failed to auto-fill HOD details', 'error');
      }
    }

    // Auto-fill HOD signature in form
    async function autoFillHODSignatureInForm() {
      try {
        const response = await fetch('/api/hod/get-signature', {
          credentials: 'include'
        });

        if (response.ok) {
          const data = await response.json();
          if (data.success && data.signatureUrl) {
            const sigArea = document.getElementById('signatureArea');
            if (sigArea) {
              sigArea.innerHTML = `<img src="${data.signatureUrl}" alt="HOD Signature" style="max-height: 60px; max-width: 100%; border: 2px solid #28a745; border-radius: 4px;">`;
              sigArea.classList.add('has-signature');
              sigArea.title = 'HOD signature auto-loaded';
            }
          }
        }
      } catch (error) {
      }
    }

    // Initialize form with role detection and HOD auto-fill
    async function initializeForm() {
      try {
        // Get form ID from URL
        const urlParams = new URLSearchParams(window.location.search);
        formId = urlParams.get("formId") || "";

        // Get user role from session
        await getUserRole();

        // Auto-fill HOD details if in HOD review mode
        if (isHODReview()) {
          setTimeout(autoFillHODDetailsInForm, 1000);
        }

        // Load HOD profile if user is HOD (existing functionality)
        if (currentUserRole === 'hod') {
          await loadHODProfile();
          await loadHODSignature();
        }

        // Load existing form data
        await loadFormData();

        // Set up role-based permissions
        setupRoleBasedAccess();

        // Initialize signature handling
        initializeSignatureHandling();

      } catch (error) {
        showMessage('Error loading form. Please refresh the page.', 'error');
      }
    }

    // Get user role from session
    async function getUserRole() {
      try {
        const response = await fetch('/api/auth/check-session', {
          credentials: 'include'
        });

        if (response.ok) {
          const data = await response.json();
          currentUserRole = data.role || '';
        }
      } catch (error) {
        currentUserRole = 'employee'; // Default fallback
      }
    }

    // Load HOD profile and auto-fill fields
    async function loadHODProfile() {
      try {

        const response = await fetch('/api/hod/profile', {
          credentials: 'include'
        });

        if (response.ok) {
          const data = await response.json();
          if (data.success) {
            // Auto-fill HOD fields
            const hodName = document.getElementById('hodName');
            const hodEmpNo = document.getElementById('hodEmpNo');
            const hodEmail = document.getElementById('hodEmail');

            if (hodName) {
              hodName.value = data.hodData.name;
              hodName.classList.add('auto-filled');
            }
            if (hodEmpNo) {
              hodEmpNo.value = data.hodData.employeeId;
              hodEmpNo.classList.add('auto-filled');
            }
            if (hodEmail) {
              hodEmail.value = data.hodData.email;
              hodEmail.classList.add('auto-filled');
            }

          }
        }
      } catch (error) {
      }
    }

    // Load existing HOD signature
    async function loadHODSignature() {
      try {
        const response = await fetch('/api/hod/get-signature', {
          credentials: 'include'
        });

        if (response.ok) {
          const data = await response.json();
          if (data.success && data.signatureUrl) {
            const sigArea = document.getElementById('signatureArea');
            if (sigArea) {
              sigArea.innerHTML = `<img src="${data.signatureUrl}" alt="HOD Signature" style="max-height: 60px; max-width: 100%;">`;
              sigArea.classList.add('has-signature');
            }
          }
        }
      } catch (error) {
      }
    }

    // Initialize signature upload handling
    function initializeSignatureHandling() {
      const signatureArea = document.getElementById('signatureArea');
      const signatureInput = document.getElementById('signatureInput');

      if (signatureArea && signatureInput) {
        signatureArea.addEventListener('click', () => {
          if (currentUserRole === 'hod') {
            signatureInput.click();
          }
        });

        signatureInput.addEventListener('change', handleSignatureUpload);
      }
    }

    // Handle signature file upload
    async function handleSignatureUpload(event) {
      const file = event.target.files[0];
      if (!file) return;

      try {
        // Preview signature
        const reader = new FileReader();
        reader.onload = function (e) {
          const sigArea = document.getElementById('signatureArea');
          if (sigArea) {
            sigArea.innerHTML = `<img src="${e.target.result}" alt="HOD Signature" style="max-height: 60px; max-width: 100%;">`;
            sigArea.classList.add('has-signature');
          }
        };
        reader.readAsDataURL(file);

        // Upload to server
        const formData = new FormData();
        formData.append('signature', file);

        const response = await fetch('/api/hod/upload-signature', {
          method: 'POST',
          body: formData,
          credentials: 'include'
        });

        if (response.ok) {
          showMessage('Signature uploaded successfully', 'success');
        } else {
          throw new Error('Failed to upload signature');
        }

      } catch (error) {
        showMessage('Failed to upload signature', 'error');
      }
    }

    // Set up role-based access control
    function setupRoleBasedAccess() {
      document.querySelectorAll('[data-role]').forEach(section => {
        const roleType = section.getAttribute('data-role');
        const shouldBeEditable = (
          (roleType === 'employee' && currentUserRole === 'employee') ||
          (roleType === 'hod' && currentUserRole === 'hod') ||
          (roleType === 'it' && currentUserRole === 'it')
        );

        if (!shouldBeEditable) {
          section.classList.add('readonly-section');
        }
      });

      // Lock form fields for HOD except HOD-specific fields
      if (currentUserRole === 'hod') {
        document.querySelectorAll('input:not([id^="hod"]), select').forEach(input => {
          input.setAttribute('readonly', true);
          input.style.backgroundColor = '#f8f9fa';
        });
      }
    }

    // Enhanced save function with HOD data
    async function saveForm365Disposal() {
      try {
        showMessage('Saving form...', 'info');

        const formData = collectFormData();

        // Determine endpoint based on role
        const endpoint = currentUserRole === 'hod'
          ? '/api/hod/save-form365-disposal'
          : '/api/employee/save-form365-disposal';

        // Save to server
        const response = await fetch(endpoint, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          credentials: 'include',
          body: JSON.stringify({ form365Disposal: formData })
        });

        const result = await response.json();

        if (response.ok && result.success) {
          // Save to localStorage for dashboard access
          localStorage.setItem('form365Data', JSON.stringify(formData));

          showMessage(result.message || 'Form saved successfully!', 'success');
        } else {
          throw new Error(result.message || 'Failed to save form');
        }

      } catch (error) {
        showMessage('Failed to save form: ' + error.message, 'error');
      }
    }

    // Collect all form data including HOD fields
    function collectFormData() {
      const getValue = (name) => {
        const el = document.querySelector(`[name="${name}"]`) || document.getElementById(name);
        if (!el) return "";
        return el.value || "";
      };

      const formData = {
        // Basic form fields
        reason: getValue("reason"),
        unitName: getValue("unitName"),
        department: getValue("department"),
        fromId: getValue("fromId"),
        empSalutation: getValue("empSalutation"),
        empName: getValue("empName"),
        designation: getValue("designation"),
        empNo: getValue("empNo"),
        oldId: getValue("oldId"),
        newId: getValue("newId"),
        toSalutation: getValue("toSalutation"),
        toEmp: getValue("toEmp"),
        toDesignation: getValue("toDesignation"),
        toEmpNo: getValue("toEmpNo"),
        date: getValue("date"),
        disposedId: getValue("disposedId"),

        // HOD fields (auto-filled)
        hodName: getValue("hodName"),
        hodEmpNo: getValue("hodEmpNo"),
        hodEmail: getValue("hodEmail"),

        // Metadata
        formId: formId,
        lastUpdated: new Date().toISOString(),
        userRole: currentUserRole
      };

      // Include signature if present
      const sigImg = document.querySelector("#signatureArea img");
      if (sigImg) formData.signatureDataUrl = sigImg.src;

      return formData;
    }

    // Load existing form data
    async function loadFormData() {
      try {
        let formData = null;

        if (formId && (currentUserRole === 'hod' || currentUserRole === 'it')) {
          // Load from server for HOD/IT review
          const response = await fetch(`/api/hod/form-details?formId=${encodeURIComponent(formId)}`, {
            credentials: 'include'
          });
          const data = await response.json();
          // Use 'form365Data' key as per your form mapping
          formData = data?.form?.formResponses?.form365Data;
        } else {
          // Load from server for employee
          const response = await fetch('/api/employee/form-data?formName=form365Disposal', {
            credentials: 'include'
          });
          const data = await response.json();
          formData = data?.formData;
        }

        if (formData) {
          // Populate form fields
          const allFields = [
            "reason", "unitName", "department", "fromId", "empSalutation", "empName",
            "designation", "empNo", "oldId", "newId", "toSalutation", "toEmp",
            "toDesignation", "toEmpNo", "date", "disposedId", "hodName", "hodEmpNo", "hodEmail"
          ];

          allFields.forEach(name => {
            const el = document.querySelector(`[name="${name}"]`) || document.getElementById(name);
            if (el) el.value = formData[name] || "";
          });

          // Show signature if available
          if (formData.signatureDataUrl) {
            const sigArea = document.getElementById("signatureArea");
            if (sigArea) {
              sigArea.innerHTML = `<img src="${formData.signatureDataUrl}" alt="HOD Signature" style="max-height: 60px; max-width: 100%;">`;
              sigArea.classList.add('has-signature');
            }
          }

        }

      } catch (error) {
      }
    }

    // Show status messages
    function showMessage(message, type) {
      const messageEl = document.getElementById('saveMessage');
      if (messageEl) {
        messageEl.textContent = message;
        messageEl.className = `save-message ${type}`;
        messageEl.style.display = 'block';

        // Auto-hide success messages
        if (type === 'success') {
          setTimeout(() => {
            messageEl.style.display = 'none';
          }, 3000);
        }
      }
    }

    // Keep backward compatibility
    function saveForm() {
      return saveForm365Disposal();
    }

    // Initialize navigation for specific form type
    document.addEventListener('DOMContentLoaded', () => {
      // Determine form type from URL or page structure
      const formType = window.location.pathname.includes('disposal') ? 'disposal' :
        window.location.pathname.includes('efile') ? 'efile' :
          window.location.pathname.includes('365transfer') ? 'form365transfer' :
            window.location.pathname.includes('365disposal') ? 'form365disposal' : 'unknown';

      // Initialize navigation for this form
      FormNavigationIntegration.initializeForForm(formType);

    });

    // Enhanced role-based element hiding with proper selectors
    function initializeRoleBasedUI() {

      // Multiple methods to detect user role
      function detectUserRole() {
        // Method 1: From localStorage/sessionStorage
        let role = localStorage.getItem('userRole') || sessionStorage.getItem('userRole');

        // Method 2: From page title or URL
        if (!role) {
          if (window.location.href.includes('hod') || window.location.href.includes('HOD')) {
            role = 'HOD';
          } else if (window.location.href.includes('itreview') || window.location.href.includes('IT')) {
            role = 'IT';
          }
        }

        // Method 3: From a meta tag or hidden input
        const roleElement = document.querySelector('meta[name="user-role"]') ||
          document.querySelector('input[name="userRole"]');
        if (!role && roleElement) {
          role = roleElement.content || roleElement.value;
        }

        // Method 4: From server-rendered data
        if (!role && typeof window.userRole !== 'undefined') {
          role = window.userRole;
        }

        // Method 5: From authentication/session cookies (if available)
        if (!role && document.cookie) {
          const cookieRole = document.cookie
            .split('; ')
            .find(row => row.startsWith('userRole='));
          if (cookieRole) {
            role = cookieRole.split('=')[1];
          }
        }

        return role ? role.toLowerCase() : null;
      }

      const userRole = detectUserRole();

      if (userRole === 'hod' || userRole === 'it') {

        // Hide back buttons with multiple selectors
        const elementsToHide = [
          '.global-back-button',
          '.back-btn',
          'button[onclick*="goBack"]',
          'button[onclick*="history.back"]',
          'button[onclick*="window.history"]',
          'a[href*="dashboard"]',
          'a[href*="back"]',
          '.navigation-back',
          '.back-to-dashboard',
          '[class*="back"]',
          '[id*="back"]'
        ];

        elementsToHide.forEach(selector => {
          try {
            const elements = document.querySelectorAll(selector);
            elements.forEach(el => {
              const elementText = el.textContent.toLowerCase();
              const isBackButton = elementText.includes('back') ||
                elementText.includes('dashboard') ||
                el.onclick?.toString().includes('back') ||
                el.onclick?.toString().includes('goBack');

              if (isBackButton || selector.includes('back') || selector.includes('dashboard')) {
                el.style.display = 'none';
                el.setAttribute('tabindex', '-1');
                el.setAttribute('aria-hidden', 'true');
              }
            });
          } catch (error) {
          }
        });

        // Hide save buttons using proper selectors
        const saveSelectors = [
          'button[type="submit"]',
          'input[type="submit"]',
          '.save-button',
          '.save-btn',
          'button[onclick*="save"]',
          'button[onclick*="submit"]',
          'button[onclick*="Save"]',
          '#saveBtn',
          '#submitBtn',
          '[value*="Save"]',
          '[value*="Submit"]',
          'input[value*="Save"]',
          '.btn-primary[onclick*="save"]'
        ];

        saveSelectors.forEach(selector => {
          try {
            const elements = document.querySelectorAll(selector);
            elements.forEach(el => {
              const elementText = (el.textContent || el.value || el.innerHTML || '').toLowerCase();
              const isSaveButton = elementText.includes('save') ||
                elementText.includes('submit') ||
                el.type === 'submit' ||
                el.name === 'submit' ||
                el.id?.includes('save') ||
                el.className?.includes('save');

              if (isSaveButton) {
                // Hide completely (not just disable)
                el.style.display = 'none !important';
                el.setAttribute('aria-hidden', 'true');
                el.setAttribute('tabindex', '-1');

                // Also hide parent container if it only contains the save button
                const parent = el.parentElement;
                if (parent && parent.children.length === 1) {
                  parent.style.display = 'none';
                }

                // Remove from form submission
                if (el.form) {
                  el.remove();
                }
              }
            });
          } catch (error) {
          }
        });

        // Hide save buttons by text content using safe method
        const allButtons = document.querySelectorAll('button, input[type="button"], input[type="submit"]');
        allButtons.forEach(button => {
          const text = (button.textContent || button.value || '').toLowerCase();
          if (text.includes('save') || text.includes('submit') || text.includes('update')) {
            button.style.display = 'none !important';
            button.setAttribute('aria-hidden', 'true');

            // Hide parent if it's a button container
            const parent = button.parentElement;
            if (parent && (parent.className.includes('button') || parent.className.includes('action'))) {
              parent.style.display = 'none';
            }
          }
        });

        // Add role-based CSS class
        document.body.classList.add(`role-${userRole}`);
        document.body.setAttribute('data-user-role', userRole);

      } else {
      }
    }

    // Run multiple times to catch all elements
    document.addEventListener('DOMContentLoaded', initializeRoleBasedUI);
    window.addEventListener('load', initializeRoleBasedUI);

    // Check again after navigation manager loads
    setTimeout(initializeRoleBasedUI, 500);
    setTimeout(initializeRoleBasedUI, 2000);
    setTimeout(initializeRoleBasedUI, 4000);

    // Set up observer for dynamically added elements
    if (typeof MutationObserver !== 'undefined') {
      const observer = new MutationObserver(function (mutations) {
        let shouldReapply = false;

        mutations.forEach(function (mutation) {
          if (mutation.addedNodes.length > 0) {
            mutation.addedNodes.forEach(function (node) {
              if (node.nodeType === Node.ELEMENT_NODE) {
                const hasSaveButton = node.querySelector && (
                  node.querySelector('button[type="submit"]') ||
                  node.querySelector('.save-button') ||
                  node.querySelector('input[type="submit"]') ||
                  (node.textContent && node.textContent.toLowerCase().includes('save'))
                );

                if (hasSaveButton) {
                  shouldReapply = true;
                }
              }
            });
          }
        });

        if (shouldReapply) {
          setTimeout(initializeRoleBasedUI, 100);
        }
      });

      observer.observe(document.body, {
        childList: true,
        subtree: true
      });
    }

    // Message listener for iframe data population
    window.addEventListener('message', function (event) {

      if (event.data && event.data.action === 'populateForm') {
        const data = event.data.data;

        // Loop through all data fields and populate matching elements
        Object.keys(data).forEach(fieldId => {
          const element = document.getElementById(fieldId) || document.querySelector(`[name="${fieldId}"]`);
          if (element) {
            if (element.tagName === 'INPUT' || element.tagName === 'TEXTAREA' || element.tagName === 'SELECT') {
              element.value = data[fieldId] || '';
            } else if (element.tagName === 'IMG') {
              element.src = data[fieldId] || '';
            } else {
              element.textContent = data[fieldId] || '';
            }
          }
        });

        // If read-only mode, disable all inputs
        if (event.data.isReadOnly) {
          document.querySelectorAll('input, select, textarea, button').forEach(el => {
            el.disabled = true;
            el.style.backgroundColor = '#f8f9fa';
            el.style.cursor = 'not-allowed';
          });
        }
      }

      if (event.data && event.data.action === 'setMode') {
        if (event.data.isReadOnly) {
          document.querySelectorAll('input, select, textarea, button').forEach(el => {
            el.disabled = true;
            el.style.backgroundColor = '#f8f9fa';
          });
        }
      }
    });

    // Also check URL parameters for data (fallback method)
    window.addEventListener('DOMContentLoaded', function () {
      const urlParams = new URLSearchParams(window.location.search);
      const mode = urlParams.get('mode');
      const existingData = urlParams.get('existingData');

      if (existingData) {
        try {
          const data = JSON.parse(decodeURIComponent(existingData));

          Object.keys(data).forEach(fieldId => {
            const element = document.getElementById(fieldId) || document.querySelector(`[name="${fieldId}"]`);
            if (element && element.value !== undefined) {
              element.value = data[fieldId] || '';
            }
          });
        } catch (error) {
        }
      }

      if (mode === 'approved' || mode === 'rejected') {
        document.querySelectorAll('input, select, textarea, button').forEach(el => {
          el.disabled = true;
          el.style.backgroundColor = '#f8f9fa';
        });
      }
    });
  </script>

  <script>
    document.addEventListener('DOMContentLoaded', () => {
      FormNavigationIntegration.initializeForForm('form365disposal');
    });
  </script>

</body>

</html>